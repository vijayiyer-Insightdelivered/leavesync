<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LeaveSync</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<style>
  :root{
    --bg:#F7F6F2;--surface:#FFF;--border:#E6E5DF;--text:#1A1A18;
    --muted:#74726A;--subtle:#F0EFE9;--navy:#0C1D3A;--navy2:#1A3356;
    --uk-bg:#EBF3FF;--uk-text:#1251A3;--uk-acc:#2563EB;
    --in-bg:#FFF2E6;--in-text:#B34500;--in-acc:#EA6C00;
    --green:#15803D;--green-bg:#ECFDF5;
    --amber:#92400E;--amber-bg:#FFFBEB;
    --red:#991B1B;--red-bg:#FEF2F2;
    --radius:12px;--shadow:0 1px 4px rgba(0,0,0,.07);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);font-size:14px;min-height:100vh}
  button,input,select,textarea{font-family:inherit;font-size:14px}
  button{cursor:pointer}
  ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#CCC;border-radius:3px}

  /* Login screen */
  #login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--navy) 0%,#1A3356 60%,#0D2A4A 100%)}
  .login-card{background:#fff;border-radius:20px;padding:48px 44px;max-width:420px;width:100%;box-shadow:0 32px 80px rgba(0,0,0,.35);text-align:center}
  .login-logo{font-family:'Playfair Display',serif;font-size:38px;color:var(--navy);margin-bottom:6px}
  .login-sub{font-size:13px;color:var(--muted);margin-bottom:32px;letter-spacing:.3px}
  .login-divider{height:1px;background:var(--border);margin:28px 0}
  .login-note{font-size:12px;color:var(--muted);margin-top:18px;line-height:1.6}
  .ms-btn{display:flex;align-items:center;justify-content:center;gap:12px;width:100%;padding:13px 20px;border:1.5px solid var(--border);border-radius:10px;background:#fff;font-size:14px;font-weight:600;color:var(--text);cursor:pointer;transition:all .18s}
  .ms-btn:hover{background:#F8F8F8;border-color:#94A3B8;box-shadow:0 4px 14px rgba(0,0,0,.08)}
  .ms-logo{width:20px;height:20px;display:grid;grid-template-columns:1fr 1fr;gap:2px}
  .ms-logo div{border-radius:1px}

  /* Loading */
  #loading-screen{display:none;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);flex-direction:column;gap:16px}
  .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--navy);border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* App layout */
  #app-screen{display:none;min-height:100vh}
  #layout{display:flex;min-height:100vh}
  #sidebar{width:212px;background:var(--navy);display:flex;flex-direction:column;flex-shrink:0;position:sticky;top:0;height:100vh}
  #main{flex:1;padding:28px 32px;overflow-x:auto;min-width:0}

  /* Sidebar */
  .brand{padding:24px 18px 20px}
  .brand-name{font-family:'Playfair Display',serif;font-size:20px;color:#fff;line-height:1.15}
  .brand-sub{font-size:9px;color:#64748B;letter-spacing:1.2px;text-transform:uppercase;margin-top:5px}
  nav{flex:1;padding:0 10px}
  .nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border:none;border-radius:9px;margin-bottom:2px;
    text-align:left;font-size:13px;font-weight:400;background:transparent;color:#94A3B8;transition:all .15s}
  .nav-btn.active{background:rgba(255,255,255,.13);color:#fff;font-weight:600}
  .nav-btn:hover:not(.active){background:rgba(255,255,255,.07);color:#CBD5E1}
  .nav-icon{font-size:14px;width:18px;text-align:center}
  .sidebar-footer{padding:14px 16px;border-top:1px solid rgba(255,255,255,.07)}
  .user-info{display:flex;align-items:center;gap:9px;margin-bottom:12px}
  .user-av{width:34px;height:34px;border-radius:8px;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0}
  .user-name{font-size:12px;font-weight:600;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .user-role{font-size:10px;color:#64748B;margin-top:1px}
  .sign-out-btn{width:100%;padding:7px;border:1px solid rgba(255,255,255,.12);border-radius:7px;background:transparent;color:#94A3B8;font-size:11px;cursor:pointer;transition:all .15s}
  .sign-out-btn:hover{background:rgba(255,255,255,.08);color:#fff}
  .country-pills{display:flex;gap:7px;margin-top:10px}
  .cpill{flex:1;padding:6px;background:rgba(255,255,255,.07);border-radius:7px;text-align:center}
  .cpill-flag{font-size:13px}
  .cpill-label{font-size:8px;color:#64748B;margin-top:1px}
  .cpill-count{font-size:13px;color:#fff;font-weight:700}

  /* Role badge */
  .role-badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:18px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
  .role-admin{background:#FEF3C7;color:#92400E}
  .role-hr{background:#EDE9FE;color:#5B21B6}
  .role-manager{background:#DBEAFE;color:#1251A3}
  .role-employee{background:#ECFDF5;color:#15803D}

  /* Top bar */
  #topbar{display:flex;justify-content:flex-end;align-items:center;gap:8px;margin-bottom:24px;flex-wrap:wrap}
  .year-btn{padding:5px 13px;border:1.5px solid var(--border);border-radius:18px;font-size:12px;font-weight:600;background:#fff;color:var(--muted);transition:all .14s}
  .year-btn.active{border-color:#2563EB;background:#EBF3FF;color:#1251A3}

  /* Buttons */
  .btn-primary{padding:8px 16px;border:none;border-radius:9px;font-weight:600;color:#fff;background:linear-gradient(135deg,var(--navy),var(--navy2));transition:opacity .15s,transform .15s}
  .btn-primary:hover{opacity:.88;transform:translateY(-1px)}
  .btn-ghost{padding:8px 16px;border:1.5px solid var(--border);border-radius:9px;font-weight:600;background:#fff;color:var(--muted);transition:all .15s}
  .btn-ghost:hover{border-color:#94A3B8;color:var(--text)}
  .btn-sm{padding:6px 12px;font-size:12px}
  .btn-danger{border-color:#FCA5A5!important;color:#EF4444!important}
  .btn-approve{border:none;border-radius:9px;padding:8px 16px;font-weight:600;color:#fff;background:linear-gradient(135deg,#15803D,#16A34A);cursor:pointer;transition:opacity .15s}
  .btn-approve:hover{opacity:.88}

  /* Cards */
  .card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);transition:box-shadow .18s}
  .card-header{display:flex;justify-content:space-between;align-items:center;padding:13px 16px;border-bottom:1px solid var(--border)}
  .card-title{font-size:14px;font-weight:700;color:var(--navy)}

  /* Page header */
  .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:22px;flex-wrap:wrap;gap:12px}
  .page-title{font-family:'Playfair Display',serif;font-size:26px;color:var(--navy);letter-spacing:-.3px}
  .page-sub{font-size:12px;color:var(--muted);margin-top:3px}

  /* KPIs */
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
  .kpi{background:var(--surface);border-radius:var(--radius);padding:18px 16px 15px;box-shadow:var(--shadow);border-top:3px solid transparent;transition:box-shadow .18s,transform .18s}
  .kpi:hover{box-shadow:0 6px 22px rgba(0,0,0,.09);transform:translateY(-1px)}
  .kpi-icon{font-size:22px;margin-bottom:8px}
  .kpi-val{font-family:'Playfair Display',serif;font-size:30px;font-weight:700;color:var(--navy);line-height:1}
  .kpi-label{font-size:13px;font-weight:600;color:var(--text);margin-top:5px}
  .kpi-sub{font-size:11px;color:var(--muted);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  /* Progress */
  .progress-track{background:var(--subtle);border-radius:4px;height:6px;overflow:hidden}
  .progress-fill{height:100%;border-radius:4px;transition:width .5s ease}

  /* Tables */
  .tbl{width:100%;border-collapse:collapse}
  .tbl th{padding:8px 12px;font-size:9.5px;font-weight:700;color:var(--muted);text-align:left;text-transform:uppercase;letter-spacing:.5px;background:var(--subtle)}
  .tbl td{padding:9px 12px;border-bottom:1px solid var(--border);vertical-align:middle}
  .tbl tr:last-child td{border-bottom:none}
  .tbl tr:hover td{background:#F9F8F4}
  .tbl-click tr{cursor:pointer}

  /* Badges */
  .badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:18px;font-size:10.5px;font-weight:700}
  .badge-dot{width:5px;height:5px;border-radius:50%}
  .badge-approved{background:var(--green-bg);color:var(--green)}
  .badge-pending{background:var(--amber-bg);color:var(--amber)}
  .badge-rejected{background:var(--red-bg);color:var(--red)}
  .badge-uk{background:var(--uk-bg);color:var(--uk-text)}
  .badge-india{background:var(--in-bg);color:var(--in-text)}

  /* Avatar */
  .av{display:flex;align-items:center;justify-content:center;font-weight:700;border-radius:9px;flex-shrink:0}

  /* Mini stats */
  .mini-grid{display:grid;gap:5px}
  .mini{background:var(--subtle);border-radius:7px;padding:6px 8px;text-align:center}
  .mini-val{font-size:13px;font-weight:600;color:var(--navy)}
  .mini-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-top:1px}

  /* Employee grid */
  .emp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:13px}
  .emp-card{background:var(--surface);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);transition:box-shadow .18s,transform .18s}
  .emp-card:hover{box-shadow:0 6px 20px rgba(0,0,0,.09);transform:translateY(-1px)}

  /* Filters */
  .filters{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
  .seg{display:flex;gap:3px;background:var(--subtle);border-radius:9px;padding:3px}
  .seg-btn{padding:5px 11px;border:none;border-radius:7px;font-size:11.5px;font-weight:600;background:transparent;color:var(--muted);transition:all .14s}
  .seg-btn.active{background:#fff;color:var(--navy);box-shadow:0 1px 4px rgba(0,0,0,.08)}
  .inp{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;outline:none;color:var(--text);background:#fff;transition:border .15s}
  .inp:focus{border-color:#2563EB}
  .inp-sm{padding:7px 10px;font-size:12px}

  /* Modal */
  .overlay{position:fixed;inset:0;background:rgba(12,29,58,.52);backdrop-filter:blur(5px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fi .16s ease}
  .modal{background:var(--surface);border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow:auto;box-shadow:0 24px 60px rgba(0,0,0,.24);animation:fu .26s ease}
  .modal-lg{max-width:560px}
  .modal-header{display:flex;justify-content:space-between;align-items:center;padding:18px 22px;border-bottom:1px solid var(--border)}
  .modal-title{font-family:'Playfair Display',serif;font-size:19px;color:var(--navy)}
  .modal-close{border:none;background:var(--subtle);color:var(--muted);width:28px;height:28px;border-radius:7px;font-size:13px;display:flex;align-items:center;justify-content:center}
  .modal-body{padding:22px}
  .field{margin-bottom:13px}
  .field-label{display:block;font-size:10.5px;font-weight:700;color:var(--muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:11px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
  .cf-box{background:var(--subtle);border-radius:9px;padding:13px;margin-bottom:14px}
  .cf-title{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:9px}
  .modal-actions{display:flex;gap:9px;margin-top:18px}
  .check-row{display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-bottom:9px}
  .bal-chip{padding:9px 12px;border-radius:8px;display:flex;align-items:center;gap:8px;margin-bottom:13px;font-size:12.5px;font-weight:500}
  .bal-ok{background:var(--green-bg);color:var(--green)}
  .bal-warn{background:var(--red-bg);color:var(--red)}

  /* Calendar */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr)}
  .cal-hdr{padding:9px 0;text-align:center;font-size:9.5px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;background:var(--subtle)}
  .cal-day{min-height:82px;padding:5px;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
  .cal-day.weekend{background:#FAFAF6}
  .cal-blank{min-height:82px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:#FAFAF6}
  .cal-num{width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:12px;margin-bottom:3px}
  .cal-today .cal-num{background:var(--navy);color:#fff;font-weight:700}
  .cal-tag{font-size:7.5px;padding:1px 3px;border-radius:3px;margin-bottom:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  /* Error banner */
  .error-banner{background:#FEF2F2;border:1px solid #FECACA;border-radius:10px;padding:14px 18px;margin-bottom:16px;color:var(--red);font-size:13px;display:flex;align-items:center;gap:8px}
  .info-banner{background:var(--uk-bg);border:1px solid #BFDBFE;border-radius:10px;padding:14px 18px;margin-bottom:16px;color:var(--uk-text);font-size:13px;display:flex;align-items:center;gap:8px}

  /* Rep bars */
  .rep-bar-track{background:var(--subtle);border-radius:5px;height:10px;overflow:hidden}
  .rep-bar-fill{height:100%;border-radius:5px;transition:width .6s ease}

  /* Toast */
  .toast{position:fixed;bottom:22px;right:26px;padding:10px 18px;border-radius:10px;color:#fff;font-size:13px;font-weight:500;box-shadow:0 8px 28px rgba(0,0,0,.22);z-index:9999;display:flex;align-items:center;gap:7px;animation:fi .16s ease}
  .toast-ok{background:var(--navy)}.toast-err{background:var(--red)}

  .link{color:#2563EB;cursor:pointer;font-size:11.5px;font-weight:500}
  .section-two{display:grid;grid-template-columns:370px 1fr;gap:14px}
  .country-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
  .country-card{background:var(--surface);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}

  @keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  @keyframes fi{from{opacity:0}to{opacity:1}}
  @keyframes tab-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .tab-content{animation:tab-in .22s ease both}

  @media(max-width:900px){
    #sidebar{width:56px}
    .brand,.brand-sub,.nav-btn span:last-child,.sidebar-footer{display:none}
    .nav-btn{justify-content:center;padding:12px 0}
    #main{padding:16px}
    .kpi-grid{grid-template-columns:1fr 1fr}
    .country-row,.section-two{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<!-- Login -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">LeaveSync</div>
    <div class="login-sub">UK & India Leave Manager ¬∑ Insight Delivered</div>
    <div class="login-divider"></div>
    <button class="ms-btn" onclick="signIn()">
      <div class="ms-logo">
        <div style="background:#F25022"></div><div style="background:#7FBA00"></div>
        <div style="background:#00A4EF"></div><div style="background:#FFB900"></div>
      </div>
      Sign in with Microsoft
    </button>
    <div class="login-note">Use your Insight Delivered Microsoft 365 account.<br>Your role and permissions are managed by your admin.</div>
  </div>
</div>

<!-- Loading -->
<div id="loading-screen">
  <div class="spinner"></div>
  <div style="color:var(--muted);font-size:13px" id="loading-msg">Signing you in‚Ä¶</div>
</div>

<!-- App -->
<div id="app-screen">
  <div id="layout">
    <div id="sidebar">
      <div class="brand">
        <div class="brand-name">Leave<br>Sync</div>
        <div class="brand-sub">UK ¬∑ India Manager</div>
      </div>
      <nav id="nav"></nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-av" id="user-av">?</div>
          <div style="min-width:0">
            <div class="user-name" id="user-name">‚Äî</div>
            <div class="user-role" id="user-role-label">‚Äî</div>
          </div>
        </div>
        <button class="sign-out-btn" onclick="signOut()">Sign out</button>
        <div class="country-pills">
          <div class="cpill"><div class="cpill-flag">üá¨üáß</div><div class="cpill-label">UK</div><div class="cpill-count" id="pill-uk">0</div></div>
          <div class="cpill"><div class="cpill-flag">üáÆüá≥</div><div class="cpill-label">India</div><div class="cpill-count" id="pill-india">0</div></div>
        </div>
      </div>
    </div>
    <div id="main">
      <div id="topbar">
        <span style="font-size:12px;color:var(--muted);font-weight:500">Year:</span>
        <button class="year-btn" data-year="2024">2024</button>
        <button class="year-btn" data-year="2025">2025</button>
        <button class="year-btn" data-year="2026">2026</button>
        <button class="btn-primary btn-sm" id="btn-apply" style="margin-left:6px;display:none">+ Apply Leave</button>
        <button class="btn-primary btn-sm" id="btn-add-emp" style="display:none">+ Add Employee</button>
      </div>
      <div id="content"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>
<div id="modal-overlay" class="overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div id="modal-box" class="modal"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CLIENT_ID   = '9aef5a1d-3e5a-4e8e-bb2b-43f01bd60c95';
const TENANT_ID   = '88c82b29-b553-4794-980c-010e970904c7';
const SITE_URL    = 'https://insightdelivered.sharepoint.com/sites/TeamDocuments';
const GRAPH_BASE  = 'https://graph.microsoft.com/v1.0';

const SCOPES = ['User.Read','Sites.ReadWrite.All'];

const msalConfig = {
  auth: {
    clientId: CLIENT_ID,
    authority: `https://login.microsoftonline.com/${TENANT_ID}`,
    redirectUri: window.location.origin + window.location.pathname,
  },
  cache: { cacheLocation: 'sessionStorage', storeAuthStateInCookie: false }
};

let msalApp = null;

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  user: null,         // Azure AD user object
  role: null,         // 'Admin','HR','Manager','Employee'
  myEmpRecord: null,  // Their row in LS_Employees
  siteId: null,       // SharePoint site ID
  lists: {},          // { Employees, LeaveRequests, Roles, PublicHolidays } => list IDs
  employees: [],
  leaves: [],
  holidays: [],
  roles: [],
  tab: 'dashboard',
  year: new Date().getFullYear(),
  calMonth: new Date().getMonth(),
  calYear: new Date().getFullYear(),
  reportView: 'summary',
  leavesStatus: 'All',
  leavesCountry: 'All',
  leavesType: 'All',
  leavesSearch: '',
  empCountry: 'All',
  empSearch: '',
  holYear: null,
  loading: false,
};

const LEAVE_TYPES = ['Annual Leave','Sick Leave','Maternity/Paternity Leave','Compassionate Leave','Study Leave','Unpaid Leave'];
const DEF_ALLOW = {UK:25,India:21};

// ‚îÄ‚îÄ‚îÄ MSAL Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function signIn() {
  try {
    showLoading('Signing you in‚Ä¶');
    const result = await msalApp.loginPopup({ scopes: SCOPES });
    msalApp.setActiveAccount(result.account);
    await bootApp();
  } catch(e) {
    hideLoading();
    if (e.errorCode !== 'user_cancelled') alert('Sign in failed: ' + e.message);
  }
}

function signOut() {
  msalApp.logoutPopup({ account: msalApp.getActiveAccount() });
}

async function getToken() {
  const account = msalApp.getActiveAccount();
  if (!account) throw new Error('Not signed in');
  try {
    const r = await msalApp.acquireTokenSilent({ scopes: SCOPES, account });
    return r.accessToken;
  } catch {
    const r = await msalApp.acquireTokenPopup({ scopes: SCOPES });
    return r.accessToken;
  }
}

async function graphGet(path) {
  const token = await getToken();
  const r = await fetch(GRAPH_BASE + path, {
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' }
  });
  if (!r.ok) throw new Error(`Graph error ${r.status}: ${await r.text()}`);
  return r.json();
}

async function graphPost(path, body) {
  const token = await getToken();
  const r = await fetch(GRAPH_BASE + path, {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(`Graph error ${r.status}: ${await r.text()}`);
  return r.json();
}

async function graphPatch(path, body) {
  const token = await getToken();
  const r = await fetch(GRAPH_BASE + path, {
    method: 'PATCH',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(`Graph error ${r.status}: ${await r.text()}`);
  return r.status === 204 ? {} : r.json();
}

async function graphDelete(path) {
  const token = await getToken();
  const r = await fetch(GRAPH_BASE + path, {
    method: 'DELETE',
    headers: { Authorization: 'Bearer ' + token }
  });
  if (!r.ok) throw new Error(`Graph error ${r.status}: ${await r.text()}`);
}

// ‚îÄ‚îÄ‚îÄ SharePoint helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getSiteId() {
  const hostname = 'insightdelivered.sharepoint.com';
  const sitePath = '/sites/TeamDocuments';
  const data = await graphGet(`/sites/${hostname}:${sitePath}`);
  return data.id;
}

async function getListId(siteId, listName) {
  const data = await graphGet(`/sites/${siteId}/lists?$filter=displayName eq '${listName}'`);
  if (!data.value || data.value.length === 0) throw new Error(`List '${listName}' not found`);
  return data.value[0].id;
}

async function getListItems(siteId, listId, filter = '', select = '') {
  let url = `/sites/${siteId}/lists/${listId}/items?$expand=fields&$top=500`;
  if (filter) url += `&$filter=${encodeURIComponent(filter)}`;
  if (select) url += `&$select=${select}`;
  const data = await graphGet(url);
  return data.value.map(i => ({ id: i.id, ...i.fields }));
}

async function createListItem(siteId, listId, fields) {
  return graphPost(`/sites/${siteId}/lists/${listId}/items`, { fields });
}

async function updateListItem(siteId, listId, itemId, fields) {
  return graphPatch(`/sites/${siteId}/lists/${listId}/items/${itemId}/fields`, fields);
}

async function deleteListItem(siteId, listId, itemId) {
  return graphDelete(`/sites/${siteId}/lists/${listId}/items/${itemId}`);
}

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function bootApp() {
  showLoading('Loading your workspace‚Ä¶');
  try {
    // Get user profile
    const me = await graphGet('/me?$select=id,displayName,mail,userPrincipalName');
    S.user = me;

    // Get SharePoint site
    setLoadingMsg('Connecting to SharePoint‚Ä¶');
    S.siteId = await getSiteId();

    // Get list IDs
    setLoadingMsg('Loading lists‚Ä¶');
    const listNames = ['LS_Employees','LS_LeaveRequests','LS_Roles','LS_PublicHolidays'];
    const listIds = await Promise.all(listNames.map(n => getListId(S.siteId, n).catch(() => null)));
    S.lists = {
      Employees:      listIds[0],
      LeaveRequests:  listIds[1],
      Roles:          listIds[2],
      PublicHolidays: listIds[3],
    };

    // Check for missing lists
    const missing = listNames.filter((_,i) => !listIds[i]);
    if (missing.length > 0) {
      hideLoading();
      showSetupError(missing);
      return;
    }

    // Load all data
    setLoadingMsg('Loading team data‚Ä¶');
    await loadAllData();

    // Determine role
    const myRole = S.roles.find(r => r.AzureObjectId === S.user.id);
    S.role = myRole?.Role || 'Employee';
    S.myEmpRecord = S.employees.find(e => e.AzureObjectId === S.user.id);

    showApp();
  } catch(e) {
    hideLoading();
    console.error(e);
    showError('Failed to load: ' + e.message);
  }
}

async function loadAllData() {
  const [employees, leaves, roles, holidays] = await Promise.all([
    S.lists.Employees     ? getListItems(S.siteId, S.lists.Employees)     : [],
    S.lists.LeaveRequests ? getListItems(S.siteId, S.lists.LeaveRequests) : [],
    S.lists.Roles         ? getListItems(S.siteId, S.lists.Roles)         : [],
    S.lists.PublicHolidays? getListItems(S.siteId, S.lists.PublicHolidays): [],
  ]);
  S.employees = employees;
  S.leaves     = leaves;
  S.roles      = roles;
  S.holidays   = holidays;
}

async function refreshData() {
  await loadAllData();
  renderInPlace();
}

// ‚îÄ‚îÄ‚îÄ UI State helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoading(msg) {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('loading-screen').style.display = 'flex';
  document.getElementById('app-screen').style.display = 'none';
  setLoadingMsg(msg);
}
function setLoadingMsg(msg) {
  document.getElementById('loading-msg').textContent = msg;
}
function hideLoading() {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
}
function showApp() {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'block';
  render();
}
function showError(msg) {
  alert(msg);
  document.getElementById('login-screen').style.display = 'flex';
}
function showSetupError(missing) {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'block';
  document.getElementById('content').innerHTML = `
    <div class="error-banner" style="margin-top:40px;flex-direction:column;align-items:flex-start;gap:12px">
      <div style="font-size:15px;font-weight:700">‚ö†Ô∏è SharePoint Lists Not Found</div>
      <div>The following SharePoint lists are missing from TeamDocuments:<br><strong>${missing.join(', ')}</strong></div>
      <div>Please ask your IT admin to complete the setup using the setup guide.</div>
    </div>`;
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function today() { return new Date().toISOString().split('T')[0]; }
function uid()   { return Math.random().toString(36).slice(2,9); }

function isWeekend(ds) { const d=new Date(ds); return d.getDay()===0||d.getDay()===6; }

function isHoliday(ds, country) {
  return S.holidays.some(h => h.HolidayDate?.split('T')[0] === ds && h.Country === country);
}

function calcWorkingDays(start, end, country) {
  if (!start||!end||end<start) return 0;
  let n=0, cur=new Date(start), last=new Date(end);
  while(cur<=last) {
    const ds=cur.toISOString().split('T')[0];
    if (!isWeekend(ds) && !isHoliday(ds,country)) n++;
    cur.setDate(cur.getDate()+1);
  }
  return n;
}

function proRata(allowance, joinDate, year) {
  const join = new Date(joinDate);
  if (join.getFullYear() < year) return allowance;
  if (join.getFullYear() > year) return 0;
  const yearEnd = new Date(year,11,31);
  const total = (yearEnd - new Date(year,0,1))/864e5+1;
  const rem   = (yearEnd - join)/864e5+1;
  return Math.round(rem/total*allowance);
}

function getCarryFwd(emp, year) {
  if (!emp.CarryForwardEnabled) return 0;
  const py = year-1;
  const pyBase = proRata(emp.AnnualAllowance||25, emp.JoinDate, py);
  const pyUsed = S.leaves
    .filter(l => l.EmployeeId===String(emp.id) && l.Status!=='Rejected' && new Date(l.StartDate).getFullYear()===py)
    .reduce((s,l) => s+(parseInt(l.WorkingDays)||0), 0);
  return Math.min(Math.max(0, pyBase-pyUsed), parseInt(emp.MaxCarryForward)||5);
}

function getTotalAllowance(emp, year) {
  return proRata(emp.AnnualAllowance||25, emp.JoinDate, year) + getCarryFwd(emp, year);
}

function getUsedDays(empId, year) {
  return S.leaves
    .filter(l => l.EmployeeId===String(empId) && l.Status!=='Rejected' && new Date(l.StartDate).getFullYear()===year)
    .reduce((s,l) => s+(parseInt(l.WorkingDays)||0), 0);
}

function getVisibleLeaves() {
  // Role-based filtering
  if (S.role==='Admin' || S.role==='HR') return S.leaves;
  if (S.role==='Manager') {
    const myEmpId = S.myEmpRecord?.id;
    const myTeam  = S.employees.filter(e => e.ManagerId === S.user.id).map(e => String(e.id));
    return S.leaves.filter(l => l.AzureObjectId===S.user.id || myTeam.includes(l.EmployeeId));
  }
  // Employee ‚Äî own leaves only
  return S.leaves.filter(l => l.AzureObjectId === S.user.id);
}

function canApprove() { return S.role==='Admin'||S.role==='HR'||S.role==='Manager'; }
function canManageEmployees() { return S.role==='Admin'||S.role==='HR'; }
function isAdmin() { return S.role==='Admin'; }

function fmt(ds) {
  if (!ds) return '‚Äî';
  return new Date(ds).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
}
function fmtWday(ds) {
  return new Date(ds).toLocaleDateString('en-GB',{weekday:'long'});
}
function greet() {
  const h=new Date().getHours();
  return h<12?'morning':h<17?'afternoon':'evening';
}

function avHtml(name, country, size=34) {
  const cs = country==='UK'
    ? {bg:'#DBEAFE',text:'#1251A3',acc:'#2563EB'}
    : {bg:'#FFEDD5',text:'#B34500',acc:'#EA6C00'};
  const ini = (name||'?').split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
  const r = Math.round(size*0.26);
  return `<div class="av" style="width:${size}px;height:${size}px;border-radius:${r}px;font-size:${Math.round(size*.36)}px;background:${cs.bg};color:${cs.text};border:1.5px solid ${cs.acc}44">${ini}</div>`;
}

function statusBadge(status) {
  const map={Approved:'approved',Pending:'pending',Rejected:'rejected'};
  const dot={Approved:'#22C55E',Pending:'#F59E0B',Rejected:'#EF4444'};
  return `<span class="badge badge-${map[status]||'pending'}"><span class="badge-dot" style="background:${dot[status]||dot.Pending}"></span>${status}</span>`;
}

function countryBadge(country) {
  return `<span class="badge badge-${country==='UK'?'uk':'india'}">${country==='UK'?'üá¨üáß':'üáÆüá≥'} ${country}</span>`;
}

function roleBadge(role) {
  const cls={Admin:'role-admin',HR:'role-hr',Manager:'role-manager',Employee:'role-employee'};
  return `<span class="role-badge ${cls[role]||'role-employee'}">${role||'Employee'}</span>`;
}

// ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer=null;
function toast(msg, type='ok') {
  const el=document.getElementById('toast');
  el.className=`toast toast-${type}`;
  el.innerHTML=`${type==='ok'?'‚úì':'‚úï'} ${msg}`;
  el.style.display='flex';
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.style.display='none',3200);
}

// ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(html, large=false) {
  const box=document.getElementById('modal-box');
  box.className='modal'+(large?' modal-lg':'');
  box.innerHTML=html;
  document.getElementById('modal-overlay').style.display='flex';
}
function closeModal() {
  document.getElementById('modal-overlay').style.display='none';
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render() {
  updateSidebar();
  updateTopbar();
  updatePills();
  renderContent();
}

function renderContent() {
  const el=document.getElementById('content');
  el.innerHTML='';
  const wrap=document.createElement('div');
  wrap.className='tab-content';
  wrap.innerHTML=renderTab();
  el.appendChild(wrap);
  attachGlobalEvents();
}

function renderInPlace() {
  updatePills();
  renderContent();
}

function updateSidebar() {
  const ini = (S.user?.displayName||'?').split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('user-av').textContent = ini;
  document.getElementById('user-name').textContent = S.user?.displayName||'‚Äî';
  document.getElementById('user-role-label').textContent = S.role||'Employee';

  const tabs = [
    {key:'dashboard', label:'Dashboard', icon:'‚óà', show: true},
    {key:'myleave',   label:'My Leave',  icon:'‚óé', show: true},
    {key:'team',      label:'Team Leaves',icon:'‚óâ', show: canApprove()},
    {key:'employees', label:'Employees', icon:'üë•', show: canManageEmployees()},
    {key:'calendar',  label:'Calendar',  icon:'‚¨°', show: true},
    {key:'holidays',  label:'Holidays',  icon:'‚óá', show: true},
    {key:'reports',   label:'Reports',   icon:'‚óÜ', show: canApprove()},
  ].filter(t => t.show);

  document.getElementById('nav').innerHTML = tabs.map(t=>`
    <button class="nav-btn${S.tab===t.key?' active':''}" data-tab="${t.key}">
      <span class="nav-icon">${t.icon}</span><span>${t.label}</span>
    </button>`).join('');

  document.querySelectorAll('.nav-btn').forEach(b=>
    b.addEventListener('click',()=>{ S.tab=b.dataset.tab; render(); })
  );
}

function updateTopbar() {
  document.querySelectorAll('.year-btn').forEach(b=>{
    b.classList.toggle('active', parseInt(b.dataset.year)===S.year);
    b.onclick=()=>{ S.year=parseInt(b.dataset.year); render(); };
  });
  document.getElementById('btn-apply').style.display = 'inline-flex';
  document.getElementById('btn-add-emp').style.display = canManageEmployees() ? 'inline-flex' : 'none';
}

function updatePills() {
  document.getElementById('pill-uk').textContent    = S.employees.filter(e=>e.Country==='UK').length;
  document.getElementById('pill-india').textContent = S.employees.filter(e=>e.Country==='India').length;
}

function attachGlobalEvents() {
  document.querySelectorAll('.year-btn').forEach(b=>{
    b.onclick=()=>{ S.year=parseInt(b.dataset.year); render(); };
  });
  document.getElementById('btn-apply').onclick = ()=>openApplyLeave();
  document.getElementById('btn-add-emp').onclick = ()=>openAddEmployee();
}

function renderTab() {
  switch(S.tab) {
    case 'dashboard':  return renderDashboard();
    case 'myleave':    return renderMyLeave();
    case 'team':       return renderTeamLeaves();
    case 'employees':  return renderEmployees();
    case 'calendar':   return renderCalendar();
    case 'holidays':   return renderHolidays();
    case 'reports':    return renderReports();
    default:           return renderDashboard();
  }
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard() {
  const t = today();
  const myLeaves    = S.leaves.filter(l => l.AzureObjectId === S.user.id);
  const myPending   = myLeaves.filter(l => l.Status==='Pending').length;
  const visLeaves   = getVisibleLeaves();
  const pendingAll  = visLeaves.filter(l => l.Status==='Pending');
  const onLeave     = S.leaves.filter(l => l.Status==='Approved' && l.StartDate?.split('T')[0]<=t && l.EndDate?.split('T')[0]>=t);

  const emp = S.myEmpRecord;
  const base= emp ? proRata(emp.AnnualAllowance||25, emp.JoinDate, S.year) : 0;
  const cf  = emp ? getCarryFwd(emp, S.year) : 0;
  const tot = base+cf;
  const used= emp ? getUsedDays(emp.id, S.year) : 0;
  const rem = Math.max(0, tot-used);

  let kpis = '';
  if (S.role==='Employee') {
    kpis = `
      <div class="kpi" style="border-top-color:#2563EB">
        <div class="kpi-icon">üìÖ</div><div class="kpi-val">${rem}d</div>
        <div class="kpi-label">Leave Remaining</div><div class="kpi-sub">${used}d used of ${tot}d total</div>
      </div>
      <div class="kpi" style="border-top-color:#F59E0B">
        <div class="kpi-icon">‚è≥</div><div class="kpi-val">${myPending}</div>
        <div class="kpi-label">My Pending Requests</div><div class="kpi-sub">Awaiting approval</div>
      </div>
      <div class="kpi" style="border-top-color:#059669">
        <div class="kpi-icon">‚úÖ</div><div class="kpi-val">${myLeaves.filter(l=>l.Status==='Approved'&&new Date(l.StartDate).getFullYear()===S.year).length}</div>
        <div class="kpi-label">Approved This Year</div><div class="kpi-sub">${S.year}</div>
      </div>
      <div class="kpi" style="border-top-color:#7C3AED">
        <div class="kpi-icon">üèñÔ∏è</div><div class="kpi-val">${cf}d</div>
        <div class="kpi-label">Carried Forward</div><div class="kpi-sub">From ${S.year-1}</div>
      </div>`;
  } else {
    const onNames = onLeave.slice(0,2).map(l=>S.employees.find(e=>String(e.id)===l.EmployeeId)?.Title?.split(' ')[0]||'').filter(Boolean);
    kpis = `
      <div class="kpi" style="border-top-color:#2563EB">
        <div class="kpi-icon">üë•</div><div class="kpi-val">${S.employees.length}</div>
        <div class="kpi-label">Employees</div>
        <div class="kpi-sub">${S.employees.filter(e=>e.Country==='UK').length} UK ¬∑ ${S.employees.filter(e=>e.Country==='India').length} India</div>
      </div>
      <div class="kpi" style="border-top-color:#F59E0B;cursor:pointer" onclick="S.tab='team';render()">
        <div class="kpi-icon">‚è≥</div><div class="kpi-val">${pendingAll.length}</div>
        <div class="kpi-label">Pending Approval</div><div class="kpi-sub">Awaiting action</div>
      </div>
      <div class="kpi" style="border-top-color:#7C3AED">
        <div class="kpi-icon">‚úàÔ∏è</div><div class="kpi-val">${onLeave.length}</div>
        <div class="kpi-label">On Leave Today</div>
        <div class="kpi-sub">${onLeave.length?onNames.join(', ')+(onLeave.length>2?` +${onLeave.length-2}`:''):'Nobody away'}</div>
      </div>
      <div class="kpi" style="border-top-color:#059669">
        <div class="kpi-icon">üìã</div><div class="kpi-val">${visLeaves.filter(l=>new Date(l.StartDate).getFullYear()===S.year).length}</div>
        <div class="kpi-label">Requests ${S.year}</div>
        <div class="kpi-sub">${visLeaves.filter(l=>l.Status==='Approved'&&new Date(l.StartDate).getFullYear()===S.year).length} approved</div>
      </div>`;
  }

  const recentRows = ([...getVisibleLeaves()]
    .sort((a,b)=>(b.AppliedOn||'').localeCompare(a.AppliedOn||''))
    .slice(0,8)
    .map(l=>{
      const e=S.employees.find(x=>String(x.id)===l.EmployeeId);
      return `<tr onclick="openLeaveDetail('${l.id}')" style="cursor:pointer">
        <td style="display:flex;align-items:center;gap:8px;padding:9px 12px">
          ${avHtml(e?.Title,e?.Country,28)}
          <div><div style="font-size:13px;font-weight:600">${e?.Title||'‚Äî'}</div>
          <div style="font-size:10px;color:var(--muted)">${e?.Country==='UK'?'üá¨üáß':'üáÆüá≥'} ${l.LeaveType||''}</div></div>
        </td>
        <td style="font-size:12px">${fmt(l.StartDate?.split('T')[0])}</td>
        <td style="font-size:14px;font-weight:700;color:var(--navy)">${l.WorkingDays||0}d</td>
        <td>${statusBadge(l.Status)}</td>
      </tr>`;
    }).join(''));

  const pendingRows = pendingAll.slice(0,5).map(l=>{
    const e=S.employees.find(x=>String(x.id)===l.EmployeeId);
    return `<div onclick="openLeaveDetail('${l.id}')" style="display:flex;justify-content:space-between;align-items:center;padding:9px 14px;cursor:pointer;border-bottom:1px solid var(--border)">
      <div style="display:flex;gap:9px;align-items:center">
        ${avHtml(e?.Title,e?.Country)}
        <div><div style="font-size:13px;font-weight:600">${e?.Title||'‚Äî'}</div>
        <div style="font-size:10px;color:var(--muted)">${l.LeaveType} ¬∑ ${l.WorkingDays||0}d</div></div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--muted)">${fmt(l.StartDate?.split('T')[0])}</div>
        ${statusBadge(l.Status)}
      </div>
    </div>`;
  }).join('');

  return `
  <div class="page-header">
    <div>
      <div class="page-title">Good ${greet()}, ${S.user?.displayName?.split(' ')[0]||'there'}</div>
      <div class="page-sub">
        ${roleBadge(S.role)} &nbsp;¬∑&nbsp; ${S.year} overview
        ${emp?`&nbsp;¬∑&nbsp; ${emp.Country==='UK'?'üá¨üáß':'üáÆüá≥'} ${emp.Country}`:''}
      </div>
    </div>
    ${!emp&&canManageEmployees()?`<div class="info-banner" style="margin:0;font-size:12px">‚ÑπÔ∏è Your Microsoft account isn't linked to an employee record yet. Ask an admin to add you to LS_Employees with your Azure Object ID.</div>`:''}
  </div>
  <div class="kpi-grid">${kpis}</div>

  ${S.role!=='Employee'?`<div class="country-row">${['UK','India'].map(co=>{
    const cs=co==='UK'?{flag:'üá¨üáß',acc:'var(--uk-acc)',text:'var(--uk-text)'}:{flag:'üáÆüá≥',acc:'var(--in-acc)',text:'var(--in-text)'};
    const emps=S.employees.filter(e=>e.Country===co);
    const used=emps.reduce((s,e)=>s+getUsedDays(e.id,S.year),0);
    const allow=emps.reduce((s,e)=>s+getTotalAllowance(e,S.year),0);
    const pct=allow>0?Math.min(100,Math.round(used/allow*100)):0;
    const pend=S.leaves.filter(l=>l.Status==='Pending'&&emps.some(e=>String(e.id)===l.EmployeeId)).length;
    return `<div class="country-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div style="display:flex;gap:10px;align-items:center">
          <span style="font-size:26px">${cs.flag}</span>
          <div><div style="font-size:15px;font-weight:700;color:var(--navy)">${co==='UK'?'United Kingdom':'India'}</div>
          <div style="font-size:11px;color:var(--muted)">${emps.length} employees ¬∑ Default ${DEF_ALLOW[co]}d/yr</div></div>
        </div>
        <div style="text-align:right">
          <div style="font-size:10px;color:var(--muted)">Used / Allowed</div>
          <div style="font-size:20px;font-weight:700;color:var(--navy)">${used}<span style="font-size:12px;color:var(--muted);font-weight:400"> / ${allow}</span></div>
        </div>
      </div>
      <div class="progress-track" style="margin-bottom:8px">
        <div class="progress-fill" style="width:${pct}%;background:linear-gradient(90deg,${cs.acc},${cs.text})"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
        <span>${pct}% utilised</span><span>${pend} pending</span>
      </div>
    </div>`;
  }).join('')}</div>`:''}

  <div class="section-two">
    <div class="card">
      <div class="card-header">
        <div class="card-title">${canApprove()?'Pending Requests':'My Recent Requests'}</div>
        <span class="link" onclick="S.tab='${canApprove()?'team':'myleave'}';render()">View all ‚Üí</span>
      </div>
      ${pendingAll.length===0&&canApprove()||(!canApprove()&&getVisibleLeaves().length===0)
        ?'<div style="padding:32px;text-align:center;color:var(--muted)"><div style="font-size:28px;margin-bottom:6px">üì≠</div>Nothing here yet</div>'
        :canApprove()?pendingRows
        :getVisibleLeaves().slice(0,5).map(l=>`<div onclick="openLeaveDetail('${l.id}')" style="display:flex;justify-content:space-between;align-items:center;padding:9px 14px;cursor:pointer;border-bottom:1px solid var(--border)">
          <div><div style="font-size:13px;font-weight:600">${l.LeaveType}</div>
          <div style="font-size:10px;color:var(--muted)">${fmt(l.StartDate?.split('T')[0])} ‚Äì ${fmt(l.EndDate?.split('T')[0])}</div></div>
          <div style="display:flex;align-items:center;gap:8px"><span style="font-size:13px;font-weight:700;color:var(--navy)">${l.WorkingDays||0}d</span>${statusBadge(l.Status)}</div>
        </div>`).join('')}
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">Recent Activity</div></div>
      <table class="tbl tbl-click"><thead><tr><th>Employee</th><th>Start</th><th>Days</th><th>Status</th></tr></thead>
      <tbody>${recentRows||'<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--muted)">No activity yet</td></tr>'}</tbody></table>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ MY LEAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMyLeave() {
  const emp = S.myEmpRecord;
  const myLeaves = S.leaves.filter(l => l.AzureObjectId===S.user.id)
    .sort((a,b)=>(b.AppliedOn||'').localeCompare(a.AppliedOn||''));

  if (!emp) {
    return `<div class="page-header"><div><div class="page-title">My Leave</div></div></div>
    <div class="error-banner">‚ö†Ô∏è Your Microsoft account is not linked to an employee record. Please ask your HR or Admin to add you to the system with your Azure Object ID: <strong>${S.user.id}</strong></div>`;
  }

  const base=proRata(emp.AnnualAllowance||25, emp.JoinDate, S.year);
  const cf=getCarryFwd(emp, S.year);
  const tot=base+cf;
  const used=getUsedDays(emp.id, S.year);
  const pend=myLeaves.filter(l=>l.Status==='Pending'&&new Date(l.StartDate).getFullYear()===S.year).reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0);
  const rem=Math.max(0,tot-used-pend);
  const pct=tot>0?Math.min(100,Math.round(used/tot*100)):0;
  const cs=emp.Country==='UK'?{acc:'var(--uk-acc)',flag:'üá¨üáß'}:{acc:'var(--in-acc)',flag:'üáÆüá≥'};
  const isNew=new Date(emp.JoinDate).getFullYear()===S.year&&new Date(emp.JoinDate)>new Date(S.year,0,1);

  return `
  <div class="page-header">
    <div><div class="page-title">My Leave</div>
    <div class="page-sub">${cs.flag} ${emp.Country} ¬∑ ${emp.Title} ¬∑ ${S.year}</div></div>
    <button class="btn-primary btn-sm" onclick="openApplyLeave()">+ Apply for Leave</button>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:22px">
    <div class="card" style="padding:18px">
      <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px">Leave Balance ¬∑ ${S.year}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
        <div class="mini"><div class="mini-val">${base}d</div><div class="mini-lbl">Base</div></div>
        <div class="mini"><div class="mini-val" style="color:${cf>0?'#15803D':'var(--muted)'}">${cf>0?'+'+cf+'d':'‚Äî'}</div><div class="mini-lbl">Carry Fwd</div></div>
        <div class="mini"><div class="mini-val" style="font-weight:700">${tot}d</div><div class="mini-lbl">Total</div></div>
        <div class="mini"><div class="mini-val">${used}d</div><div class="mini-lbl">Used</div></div>
      </div>
      <div class="progress-track" style="margin-bottom:8px">
        <div class="progress-fill" style="width:${pct}%;background:${pct>85?'#EF4444':cs.acc}"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
        <span>${pct}% used${isNew?' ¬∑ Pro-rata':''}</span>
        <span style="font-weight:700;color:${rem<3?'#EF4444':rem<6?'#D97706':'#15803D'}">${rem}d remaining</span>
      </div>
    </div>

    <div class="card" style="padding:18px">
      <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px">This Year at a Glance</div>
      ${[['Approved',myLeaves.filter(l=>l.Status==='Approved'&&new Date(l.StartDate).getFullYear()===S.year).reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0)+'d'],
         ['Pending',pend>0?pend+'d':'None'],
         ['Sick Days',myLeaves.filter(l=>l.LeaveType==='Sick Leave'&&l.Status==='Approved'&&new Date(l.StartDate).getFullYear()===S.year).reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0)+'d'],
         ['Requests',myLeaves.filter(l=>new Date(l.StartDate).getFullYear()===S.year).length+' total'],
        ].map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:12.5px;color:var(--muted)">${l}</span>
          <span style="font-size:13px;font-weight:600;color:var(--navy)">${v}</span>
        </div>`).join('')}
    </div>

    <div class="card" style="padding:18px">
      <div style="font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px">Upcoming Public Holidays</div>
      ${S.holidays.filter(h=>h.Country===emp.Country&&h.HolidayDate?.split('T')[0]>=today()).slice(0,4).map(h=>`
        <div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:12px;color:var(--navy)">${h.Title}</span>
          <span style="font-size:11px;color:var(--muted)">${fmt(h.HolidayDate?.split('T')[0])}</span>
        </div>`).join('')||'<div style="color:var(--muted);font-size:12px;padding:8px 0">No upcoming holidays found</div>'}
    </div>
  </div>

  <div class="card" style="overflow:hidden">
    <div class="card-header"><div class="card-title">My Leave History</div></div>
    ${myLeaves.length===0?'<div style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:28px;margin-bottom:6px">üì≠</div>No leave requests yet</div>':`
    <table class="tbl tbl-click"><thead><tr>
      <th>Type</th><th>Start</th><th>End</th><th>Days</th><th>Applied</th><th>Status</th><th></th>
    </tr></thead><tbody>
    ${myLeaves.map(l=>`<tr onclick="openLeaveDetail('${l.id}')">
      <td style="font-size:13px;font-weight:500">${l.LeaveType}</td>
      <td style="font-size:12px">${fmt(l.StartDate?.split('T')[0])}</td>
      <td style="font-size:12px">${fmt(l.EndDate?.split('T')[0])}</td>
      <td style="font-size:14px;font-weight:700;color:var(--navy)">${l.WorkingDays||0}d</td>
      <td style="font-size:11px;color:var(--muted)">${fmt(l.AppliedOn?.split('T')[0])}</td>
      <td>${statusBadge(l.Status)}</td>
      <td style="color:var(--muted)">‚Ä∫</td>
    </tr>`).join('')}
    </tbody></table>`}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ TEAM LEAVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTeamLeaves() {
  const vis = getVisibleLeaves().filter(l=>{
    const e=S.employees.find(x=>String(x.id)===l.EmployeeId);
    return (S.leavesStatus==='All'||l.Status===S.leavesStatus)
      &&(S.leavesCountry==='All'||e?.Country===S.leavesCountry)
      &&(S.leavesType==='All'||l.LeaveType===S.leavesType)
      &&(S.leavesSearch===''||e?.Title?.toLowerCase().includes(S.leavesSearch.toLowerCase()));
  }).sort((a,b)=>(b.AppliedOn||'').localeCompare(a.AppliedOn||''));

  const all=getVisibleLeaves();
  const counts={All:all.length,Pending:all.filter(l=>l.Status==='Pending').length,
    Approved:all.filter(l=>l.Status==='Approved').length,Rejected:all.filter(l=>l.Status==='Rejected').length};

  const rows = vis.map(l=>{
    const e=S.employees.find(x=>String(x.id)===l.EmployeeId);
    return `<tr onclick="openLeaveDetail('${l.id}')" style="cursor:pointer">
      <td>
        <div style="display:flex;gap:8px;align-items:center">
          ${avHtml(e?.Title,e?.Country,28)}
          <div><div style="font-size:13px;font-weight:600">${e?.Title||'‚Äî'}</div>
          <div style="font-size:10px;color:var(--muted)">${e?.Country==='UK'?'üá¨üáß':'üáÆüá≥'} ${e?.Role||''}</div></div>
        </div>
      </td>
      <td style="font-size:11px;color:var(--muted)">${l.LeaveType}</td>
      <td style="font-size:12px">${fmt(l.StartDate?.split('T')[0])}</td>
      <td style="font-size:12px">${fmt(l.EndDate?.split('T')[0])}</td>
      <td style="font-size:14px;font-weight:700;color:var(--navy)">${l.WorkingDays||0}d</td>
      <td style="font-size:11px;color:var(--muted)">${fmt(l.AppliedOn?.split('T')[0])}</td>
      <td>${statusBadge(l.Status)}</td>
      <td style="color:var(--muted)">‚Ä∫</td>
    </tr>`;
  }).join('');

  return `
  <div class="page-header">
    <div><div class="page-title">Team Leave Requests</div>
    <div class="page-sub">${counts.Pending} pending approval</div></div>
    <button class="btn-primary btn-sm" onclick="openApplyLeave()">+ Apply Leave</button>
  </div>
  <div class="filters">
    <input class="inp inp-sm" value="${S.leavesSearch}" placeholder="Search employee‚Ä¶" style="width:160px" oninput="S.leavesSearch=this.value;renderInPlace()">
    <div class="seg">
      ${['All','Pending','Approved','Rejected'].map(st=>`<button class="seg-btn${S.leavesStatus===st?' active':''}" onclick="S.leavesStatus='${st}';renderInPlace()">
        ${st}<span style="margin-left:4px;font-size:9.5px;color:var(--muted)">${counts[st]}</span></button>`).join('')}
    </div>
    <select class="inp inp-sm" style="width:auto" onchange="S.leavesCountry=this.value;renderInPlace()">
      <option value="All">All Countries</option><option value="UK">üá¨üáß UK</option><option value="India">üáÆüá≥ India</option>
    </select>
    <select class="inp inp-sm" style="width:auto" onchange="S.leavesType=this.value;renderInPlace()">
      <option value="All">All Types</option>
      ${LEAVE_TYPES.map(t=>`<option value="${t}">${t}</option>`).join('')}
    </select>
    <button class="btn-ghost btn-sm" onclick="refreshData()" style="margin-left:auto">‚Üª Refresh</button>
  </div>
  <div class="card" style="overflow:hidden">
    ${vis.length===0
      ?'<div style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:28px;margin-bottom:6px">üì≠</div>No requests match your filters</div>'
      :`<table class="tbl tbl-click"><thead><tr>
        <th>Employee</th><th>Type</th><th>Start</th><th>End</th><th>Days</th><th>Applied</th><th>Status</th><th></th>
      </tr></thead><tbody>${rows}</tbody></table>`}
  </div>
  <div style="font-size:11px;color:var(--muted);margin-top:8px;text-align:right">${vis.length} record${vis.length!==1?'s':''}</div>`;
}

// ‚îÄ‚îÄ‚îÄ EMPLOYEES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEmployees() {
  const filtered = S.employees.filter(e=>
    (S.empCountry==='All'||e.Country===S.empCountry)&&
    (e.Title||'').toLowerCase().includes(S.empSearch.toLowerCase())
  );

  const cards = filtered.map(emp=>{
    const base=proRata(emp.AnnualAllowance||25,emp.JoinDate,S.year);
    const cf=getCarryFwd(emp,S.year);
    const tot=base+cf;
    const used=getUsedDays(emp.id,S.year);
    const pend=S.leaves.filter(l=>l.EmployeeId===String(emp.id)&&l.Status==='Pending').reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0);
    const rem=Math.max(0,tot-used-pend);
    const pct=tot>0?Math.min(100,Math.round(used/tot*100)):0;
    const barColor=pct>85?'#EF4444':emp.Country==='UK'?'var(--uk-acc)':'var(--in-acc)';
    const empRole=S.roles.find(r=>r.AzureObjectId===emp.AzureObjectId);
    const isNew=emp.JoinDate&&new Date(emp.JoinDate).getFullYear()===S.year&&new Date(emp.JoinDate)>new Date(S.year,0,1);
    return `<div class="emp-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div style="display:flex;gap:9px;align-items:center">
          ${avHtml(emp.Title,emp.Country,40)}
          <div><div style="font-weight:700;font-size:13.5px;color:var(--navy)">${emp.Title}</div>
          <div style="font-size:10.5px;color:var(--muted)">${emp.Role||''}</div></div>
        </div>
        ${countryBadge(emp.Country)}
      </div>
      ${empRole?`<div style="margin-bottom:10px">${roleBadge(empRole.Role)}</div>`:''}
      <div class="mini-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:8px">
        <div class="mini"><div class="mini-val">${base}d</div><div class="mini-lbl">Base</div></div>
        <div class="mini"><div class="mini-val" style="color:${cf>0?'#15803D':'var(--muted)'}">${cf>0?'+'+cf+'d':'‚Äî'}</div><div class="mini-lbl">Carry Fwd</div></div>
        <div class="mini"><div class="mini-val" style="font-weight:700">${tot}d</div><div class="mini-lbl">Total</div></div>
      </div>
      <div class="mini-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:9px">
        <div class="mini"><div class="mini-val">${used}d</div><div class="mini-lbl">Used</div></div>
        <div class="mini"><div class="mini-val" style="color:${pend>0?'#D97706':'var(--muted)'}">${pend>0?pend+'d':'‚Äî'}</div><div class="mini-lbl">Pending</div></div>
        <div class="mini"><div class="mini-val" style="color:${rem<3?'#EF4444':rem<6?'#D97706':'var(--navy)'}">${rem}d</div><div class="mini-lbl">Remaining</div></div>
      </div>
      <div class="progress-track" style="margin-bottom:8px">
        <div class="progress-fill" style="width:${pct}%;background:${barColor}"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:9.5px;color:var(--muted);margin-bottom:12px">
        <span>${pct}% used${isNew?' ¬∑ Pro-rata':''}</span>
        <span>${emp.CarryForwardEnabled?'CF max: '+(emp.MaxCarryForward||5)+'d':'No carry fwd'}</span>
      </div>
      ${isAdmin()?`<button class="btn-ghost btn-sm btn-danger" onclick="removeEmployee('${emp.id}')" style="width:100%">Remove</button>`:''}
    </div>`;
  }).join('');

  return `
  <div class="page-header">
    <div><div class="page-title">Employees</div><div class="page-sub">${S.employees.length} team members</div></div>
    <div style="display:flex;gap:8px">
      <button class="btn-ghost btn-sm" onclick="refreshData()">‚Üª Refresh</button>
      ${canManageEmployees()?`<button class="btn-primary btn-sm" onclick="openAddEmployee()">+ Add Employee</button>`:''}
    </div>
  </div>
  <div class="filters">
    <input class="inp inp-sm" value="${S.empSearch}" placeholder="Search‚Ä¶" style="width:180px" oninput="S.empSearch=this.value;renderInPlace()">
    <div class="seg">
      ${['All','UK','India'].map(o=>`<button class="seg-btn${S.empCountry===o?' active':''}" onclick="S.empCountry='${o}';renderInPlace()">${o}</button>`).join('')}
    </div>
  </div>
  <div class="emp-grid">${cards||'<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">No employees found</div>'}</div>`;
}

// ‚îÄ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCalendar() {
  const vm=S.calMonth, vy=S.calYear;
  const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const DAYS=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const dim=new Date(vy,vm+1,0).getDate();
  const blanks=(new Date(vy,vm,1).getDay()+6)%7;
  const n=new Date();

  const ds=d=>`${vy}-${String(vm+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  const isToday=d=>d===n.getDate()&&vm===n.getMonth()&&vy===n.getFullYear();

  const approvedLeaves = S.leaves.filter(l=>l.Status==='Approved');

  let cells='';
  for(let i=0;i<blanks;i++) cells+=`<div class="cal-blank"></div>`;
  for(let d=1;d<=dim;d++){
    const s=ds(d);
    const wk=isWeekend(s);
    const ukH=S.holidays.find(h=>h.Country==='UK'&&h.HolidayDate?.split('T')[0]===s);
    const inH=S.holidays.find(h=>h.Country==='India'&&h.HolidayDate?.split('T')[0]===s);
    const ll=approvedLeaves.filter(l=>l.StartDate?.split('T')[0]<=s&&l.EndDate?.split('T')[0]>=s);
    cells+=`<div class="cal-day${wk?' weekend':''} ${isToday(d)?'cal-today':''}">
      <div class="cal-num" style="color:${wk?'#CBD5E1':'var(--text)'}">${d}</div>
      ${ukH?`<div class="cal-tag" style="background:var(--uk-bg);color:var(--uk-text)">üá¨üáß ${ukH.Title}</div>`:''}
      ${inH?`<div class="cal-tag" style="background:var(--in-bg);color:var(--in-text)">üáÆüá≥ ${inH.Title}</div>`:''}
      ${ll.slice(0,2).map(l=>{
        const e=S.employees.find(x=>String(x.id)===l.EmployeeId);
        const co=e?.Country==='UK';
        return `<div class="cal-tag" style="background:${co?'var(--uk-bg)':'var(--in-bg)'};color:${co?'var(--uk-text)':'var(--in-text)'}">${co?'üá¨üáß':'üáÆüá≥'} ${e?.Title?.split(' ')[0]||''}</div>`;
      }).join('')}
      ${ll.length>2?`<div style="font-size:7.5px;color:var(--muted)">+${ll.length-2}</div>`:''}
    </div>`;
  }

  return `
  <div class="page-header">
    <div><div class="page-title">Team Calendar</div></div>
    <div style="display:flex;gap:9px;align-items:center">
      <button class="btn-ghost btn-sm" onclick="calNav(-1)">‚Äπ</button>
      <span style="font-weight:600;font-size:15px;min-width:155px;text-align:center">${MONTHS[vm]} ${vy}</span>
      <button class="btn-ghost btn-sm" onclick="calNav(1)">‚Ä∫</button>
    </div>
  </div>
  <div class="card" style="overflow:hidden">
    <div class="cal-grid">${DAYS.map(d=>`<div class="cal-hdr">${d}</div>`).join('')}${cells}</div>
  </div>
  <div style="display:flex;gap:14px;margin-top:12px;flex-wrap:wrap">
    ${[{bg:'var(--uk-bg)',c:'var(--uk-text)',l:'üá¨üáß UK on leave'},{bg:'var(--in-bg)',c:'var(--in-text)',l:'üáÆüá≥ India on leave'},
       {bg:'var(--uk-bg)',c:'var(--uk-text)',l:'üá¨üáß UK holiday'},{bg:'var(--in-bg)',c:'var(--in-text)',l:'üáÆüá≥ India holiday'}]
    .map(x=>`<div style="display:flex;align-items:center;gap:5px;font-size:10.5px;color:var(--muted)">
      <div style="width:10px;height:10px;background:${x.bg};border:1px solid ${x.c}44;border-radius:2px"></div>${x.l}</div>`).join('')}
  </div>`;
}

function calNav(dir) {
  S.calMonth+=dir;
  if(S.calMonth<0){S.calMonth=11;S.calYear--;}
  if(S.calMonth>11){S.calMonth=0;S.calYear++;}
  renderInPlace();
}

// ‚îÄ‚îÄ‚îÄ HOLIDAYS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHolidays() {
  if(!S.holYear) S.holYear=S.year;
  const yr=S.holYear;

  const col=(co,cs)=>{
    const hols=S.holidays.filter(h=>h.Country===co&&parseInt(h.Year)===yr).sort((a,b)=>a.HolidayDate?.localeCompare(b.HolidayDate));
    return `<div class="card" style="overflow:hidden">
      <div style="padding:12px 16px;border-bottom:1px solid var(--border);background:${cs.bg};display:flex;align-items:center;gap:9px">
        <span style="font-size:20px">${cs.flag}</span>
        <div><div style="font-weight:700;color:${cs.text};font-size:14px">${co==='UK'?'United Kingdom':'India'}</div>
        <div style="font-size:10.5px;color:${cs.text}99">${hols.length} statutory holidays ¬∑ ${yr}</div></div>
      </div>
      ${hols.length===0
        ?'<div style="padding:30px;text-align:center;color:var(--muted)">No holidays loaded for this year.<br><small>Admin: add entries to LS_PublicHolidays list.</small></div>'
        :hols.map((h,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 16px;${i<hols.length-1?'border-bottom:1px solid var(--border)':''}">
          <div><div style="font-size:13px;font-weight:500;color:var(--navy)">${h.Title}</div>
          <div style="font-size:10.5px;color:var(--muted)">${fmtWday(h.HolidayDate?.split('T')[0])}</div></div>
          <div style="font-size:12px;font-weight:600;color:var(--muted)">${fmt(h.HolidayDate?.split('T')[0])}</div>
        </div>`).join('')}
    </div>`;
  };

  return `
  <div class="page-header">
    <div><div class="page-title">Public Holidays</div><div class="page-sub">Loaded from LS_PublicHolidays SharePoint list</div></div>
    <div class="seg">
      ${[2024,2025,2026].map(y=>`<button class="seg-btn${S.holYear===y?' active':''}" onclick="S.holYear=${y};renderInPlace()">${y}</button>`).join('')}
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
    ${col('UK',{bg:'var(--uk-bg)',text:'var(--uk-text)',flag:'üá¨üáß'})}
    ${col('India',{bg:'var(--in-bg)',text:'var(--in-text)',flag:'üáÆüá≥'})}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReports() {
  const rows = S.employees.map(emp=>{
    const base=proRata(emp.AnnualAllowance||25,emp.JoinDate,S.year);
    const cf=getCarryFwd(emp,S.year);
    const tot=base+cf;
    const used=getUsedDays(emp.id,S.year);
    const pend=S.leaves.filter(l=>l.EmployeeId===String(emp.id)&&l.Status==='Pending').reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0);
    const rem=Math.max(0,tot-used-pend);
    const sick=S.leaves.filter(l=>l.EmployeeId===String(emp.id)&&l.LeaveType==='Sick Leave'&&l.Status==='Approved'&&new Date(l.StartDate).getFullYear()===S.year).reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0);
    return{...emp,base,cf,tot,used,pend,rem,sick};
  });

  const totals={
    allow:rows.reduce((s,r)=>s+r.tot,0),
    used:rows.reduce((s,r)=>s+r.used,0),
    cf:rows.reduce((s,r)=>s+r.cf,0),
    avgPct:rows.length?Math.round(rows.reduce((s,r)=>s+(r.tot>0?r.used/r.tot:0),0)/rows.length*100):0,
  };

  let viewHtml='';
  if(S.reportView==='summary'){
    viewHtml=`<div class="card" style="overflow:hidden">
      <table class="tbl"><thead><tr>
        <th>Employee</th><th>Country</th><th>Base</th><th>Carry Fwd</th><th>Total</th><th>Used</th><th>Pending</th><th>Remaining</th><th>Sick</th><th>Usage</th>
      </tr></thead><tbody>
      ${rows.map(r=>{
        const pct=r.tot>0?Math.round(r.used/r.tot*100):0;
        const barColor=pct>85?'#EF4444':r.Country==='UK'?'var(--uk-acc)':'var(--in-acc)';
        return `<tr>
          <td><div style="font-size:13px;font-weight:600;color:var(--navy)">${r.Title}</div><div style="font-size:10px;color:var(--muted)">${r.Role||''}</div></td>
          <td>${countryBadge(r.Country)}</td>
          <td style="font-size:12px">${r.base}d</td>
          <td style="font-size:12px;color:${r.cf>0?'#15803D':'var(--muted)'}">${r.cf>0?'+'+r.cf+'d':'‚Äî'}</td>
          <td style="font-size:12px;font-weight:700">${r.tot}d</td>
          <td style="font-size:12px">${r.used}d</td>
          <td style="font-size:12px;color:${r.pend>0?'#D97706':'var(--muted)'}">${r.pend>0?r.pend+'d':'‚Äî'}</td>
          <td style="font-size:12px;font-weight:600;color:${r.rem<3?'#EF4444':r.rem<6?'#D97706':'#15803D'}">${r.rem}d</td>
          <td style="font-size:12px;color:${r.sick>5?'#EF4444':'var(--muted)'}">${r.sick>0?r.sick+'d':'‚Äî'}</td>
          <td style="min-width:100px">
            <div style="display:flex;align-items:center;gap:5px">
              <div class="progress-track" style="flex:1;height:5px"><div class="progress-fill" style="width:${pct}%;background:${barColor}"></div></div>
              <span style="font-size:10px;font-weight:600;color:var(--muted);min-width:28px">${pct}%</span>
            </div>
          </td>
        </tr>`;
      }).join('')}
      </tbody></table>
    </div>`;
  } else if(S.reportView==='country'){
    viewHtml=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    ${['UK','India'].map(co=>{
      const cs=co==='UK'?{flag:'üá¨üáß',bg:'var(--uk-bg)',text:'var(--uk-text)',acc:'var(--uk-acc)'}:{flag:'üáÆüá≥',bg:'var(--in-bg)',text:'var(--in-text)',acc:'var(--in-acc)'};
      const gr=rows.filter(r=>r.Country===co);
      return `<div class="card" style="overflow:hidden">
        <div style="padding:12px 16px;background:${cs.bg};border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
          <span style="font-size:20px">${cs.flag}</span>
          <div style="font-weight:700;color:${cs.text};font-size:14px">${co==='UK'?'United Kingdom':'India'} ‚Äî ${gr.length} employees</div>
        </div>
        <div style="padding:14px 16px">
          ${[['Employees',gr.length],['Total allowance',gr.reduce((s,r)=>s+r.tot,0)+'d'],['Total used',gr.reduce((s,r)=>s+r.used,0)+'d'],
            ['Total pending',gr.reduce((s,r)=>s+r.pend,0)+'d'],['Total remaining',gr.reduce((s,r)=>s+r.rem,0)+'d'],
            ['Total carry forward',gr.reduce((s,r)=>s+r.cf,0)+'d'],['Sick days',gr.reduce((s,r)=>s+r.sick,0)+'d']]
          .map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border)">
            <span style="font-size:12.5px;color:var(--muted)">${l}</span>
            <span style="font-size:13px;font-weight:700;color:var(--navy)">${v}</span>
          </div>`).join('')}
        </div>
        <div style="padding:0 16px 14px">
          <div style="font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px">By employee</div>
          ${gr.map(r=>{
            const pct=r.tot>0?Math.round(r.used/r.tot*100):0;
            return `<div style="margin-bottom:9px">
              <div style="display:flex;justify-content:space-between;font-size:11.5px;margin-bottom:3px">
                <span style="font-weight:500">${r.Title}</span>
                <span style="color:var(--muted)">${r.used}d / ${r.tot}d (${pct}%)</span>
              </div>
              <div class="progress-track" style="height:5px">
                <div class="progress-fill" style="width:${pct}%;background:${pct>85?'#EF4444':cs.acc}"></div>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    }).join('')}
    </div>`;
  } else {
    const yrL=S.leaves.filter(l=>new Date(l.StartDate).getFullYear()===S.year&&l.Status!=='Rejected');
    const byType=LEAVE_TYPES.map(type=>{
      const m=yrL.filter(l=>l.LeaveType===type);
      return{type,count:m.length,days:m.reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0)};
    }).filter(x=>x.count>0).sort((a,b)=>b.days-a.days);
    const maxD=Math.max(...byType.map(x=>x.days),1);
    viewHtml=`<div class="card" style="padding:22px">
      <div style="font-size:14px;font-weight:700;color:var(--navy);margin-bottom:18px">Leave Type Breakdown ¬∑ ${S.year}</div>
      ${byType.length===0?'<div style="text-align:center;padding:30px;color:var(--muted)">No data for this year</div>':
        byType.map((x,i)=>`<div style="margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px">
            <span style="font-weight:500;color:var(--navy)">${x.type}</span>
            <span style="color:var(--muted)">${x.days} days ¬∑ ${x.count} request${x.count!==1?'s':''}</span>
          </div>
          <div class="rep-bar-track">
            <div class="rep-bar-fill" style="width:${x.days/maxD*100}%;background:hsl(${210-i*30},65%,50%)"></div>
          </div>
        </div>`).join('')}
    </div>`;
  }

  return `
  <div class="page-header">
    <div><div class="page-title">Reports & Analytics</div><div class="page-sub">Full leave analysis ¬∑ ${S.year}</div></div>
    <div style="display:flex;gap:8px">
      <button class="btn-ghost btn-sm" onclick="exportSummary()">‚¨á Summary CSV</button>
      <button class="btn-ghost btn-sm" onclick="exportDetail()">‚¨á Detail CSV</button>
      <button class="btn-ghost btn-sm" onclick="refreshData()">‚Üª Refresh</button>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:20px">
    ${[['Total Allowance',totals.allow+'d'],['Total Used',totals.used+'d'],['Total Carry Fwd',totals.cf+'d'],['Avg Utilisation',totals.avgPct+'%']].map(([l,v])=>`
      <div class="card" style="padding:14px 16px">
        <div style="font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--navy)">${v}</div>
        <div style="font-size:11.5px;color:var(--muted);margin-top:4px">${l}</div>
      </div>`).join('')}
  </div>
  <div style="margin-bottom:14px">
    <div class="seg">
      ${[['summary','Employee Summary'],['country','By Country'],['types','Leave Types']].map(([k,l])=>`
        <button class="seg-btn${S.reportView===k?' active':''}" onclick="S.reportView='${k}';renderInPlace()">${l}</button>`).join('')}
    </div>
  </div>
  ${viewHtml}`;
}

// ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddEmployee() {
  openModal(`
  <div class="modal-header">
    <div class="modal-title">Add Employee</div>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>
  <div class="modal-body">
    <div class="info-banner">The employee must have a Microsoft 365 account. Enter their Azure AD Object ID so they can log in.</div>
    <div class="field"><label class="field-label">Full Name</label><input class="inp" id="m-name" placeholder="e.g. Sarah Johnson"></div>
    <div class="field"><label class="field-label">Role / Job Title</label><input class="inp" id="m-role" placeholder="e.g. Senior Developer"></div>
    <div class="grid-2">
      <div class="field"><label class="field-label">Country</label>
        <select class="inp" id="m-country" onchange="document.getElementById('m-allow').value=this.value==='UK'?25:21">
          <option value="UK">üá¨üáß United Kingdom</option><option value="India">üáÆüá≥ India</option>
        </select>
      </div>
      <div class="field"><label class="field-label">Annual Leave (days)</label>
        <input class="inp" id="m-allow" type="number" min="0" max="60" value="25">
      </div>
    </div>
    <div class="field"><label class="field-label">Join Date</label><input class="inp" id="m-join" type="date" value="${today()}"></div>
    <div class="field"><label class="field-label">Azure AD Object ID <span style="color:var(--muted);font-size:10px">(from Azure Portal ‚Üí Users ‚Üí select user ‚Üí Object ID)</span></label>
      <input class="inp" id="m-azid" placeholder="e.g. 12a34bc5-1234-abcd-5678-abc123def456">
    </div>
    <div class="field"><label class="field-label">System Role</label>
      <select class="inp" id="m-sysrole">
        <option value="Employee">Employee</option>
        <option value="Manager">Manager</option>
        <option value="HR">HR</option>
        ${isAdmin()?'<option value="Admin">Admin</option>':''}
      </select>
    </div>
    <div class="cf-box">
      <div class="cf-title">Carry Forward</div>
      <label class="check-row"><input type="checkbox" id="m-cf" checked> Enable carry forward of unused leave</label>
      <div class="field" id="cf-max-row"><label class="field-label">Max carry forward (days)</label>
        <input class="inp" id="m-cfmax" type="number" min="0" max="20" value="5">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" style="flex:1" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" style="flex:2" onclick="saveEmployee()">Add Employee</button>
    </div>
  </div>`);
  document.getElementById('m-cf').onchange=e=>{
    document.getElementById('cf-max-row').style.display=e.target.checked?'block':'none';
  };
}

async function saveEmployee() {
  const name   = document.getElementById('m-name').value.trim();
  const role   = document.getElementById('m-role').value.trim();
  const azId   = document.getElementById('m-azid').value.trim();
  const sysRole= document.getElementById('m-sysrole').value;
  if (!name||!role) { alert('Please fill in all required fields.'); return; }

  const btn = document.querySelector('#modal-box .btn-primary');
  btn.disabled=true; btn.textContent='Saving‚Ä¶';

  try {
    // Create employee record
    const empFields = {
      Title: name,
      Role: role,
      Country: document.getElementById('m-country').value,
      AnnualAllowance: parseInt(document.getElementById('m-allow').value)||25,
      JoinDate: document.getElementById('m-join').value,
      AzureObjectId: azId,
      CarryForwardEnabled: document.getElementById('m-cf').checked,
      MaxCarryForward: parseInt(document.getElementById('m-cfmax')?.value)||5,
    };
    const newEmp = await createListItem(S.siteId, S.lists.Employees, empFields);

    // Create role record
    if (azId) {
      await createListItem(S.siteId, S.lists.Roles, {
        Title: name, AzureObjectId: azId, Role: sysRole, Email: ''
      });
    }

    await loadAllData();
    closeModal(); render();
    toast('Employee added successfully');
  } catch(e) {
    btn.disabled=false; btn.textContent='Add Employee';
    toast('Error: '+e.message, 'err');
  }
}

async function removeEmployee(id) {
  const emp = S.employees.find(e=>String(e.id)===String(id));
  if (!confirm(`Remove ${emp?.Title||'this employee'}? Their leave records will remain but they will be removed from the directory.`)) return;
  try {
    await deleteListItem(S.siteId, S.lists.Employees, id);
    await loadAllData(); render();
    toast('Employee removed');
  } catch(e) {
    toast('Error: '+e.message,'err');
  }
}

function openApplyLeave(prefillEmpId='') {
  // Determine who we're applying for
  const defaultEmpId = prefillEmpId || (S.myEmpRecord?String(S.myEmpRecord.id):'');
  const empOpts = canManageEmployees()
    ? S.employees.map(e=>`<option value="${e.id}" ${String(e.id)===defaultEmpId?'selected':''}>${e.Country==='UK'?'üá¨üáß':'üáÆüá≥'} ${e.Title}</option>`).join('')
    : S.myEmpRecord
      ? `<option value="${S.myEmpRecord.id}" selected>${S.myEmpRecord.Title}</option>`
      : '<option value="">No employee record found</option>';

  openModal(`
  <div class="modal-header">
    <div class="modal-title">Apply for Leave</div>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>
  <div class="modal-body">
    <div class="field"><label class="field-label">Employee</label>
      <select class="inp" id="m-emp" onchange="updateBalChip()" ${!canManageEmployees()?'disabled':''}>${empOpts}</select>
    </div>
    <div id="bal-chip" class="bal-chip bal-ok" style="display:none"></div>
    <div class="field"><label class="field-label">Leave Type</label>
      <select class="inp" id="m-type" onchange="updateBalChip()">
        ${LEAVE_TYPES.map(t=>`<option value="${t}">${t}</option>`).join('')}
      </select>
    </div>
    <div class="grid-2">
      <div class="field"><label class="field-label">Start Date</label><input class="inp" id="m-start" type="date" value="${today()}" onchange="updateBalChip()"></div>
      <div class="field"><label class="field-label">End Date</label><input class="inp" id="m-end" type="date" value="${today()}" onchange="updateBalChip()"></div>
    </div>
    <div class="field"><label class="field-label">Reason (optional)</label>
      <textarea class="inp" id="m-reason" rows="3" placeholder="Brief description‚Ä¶" style="resize:vertical"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" style="flex:1" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" style="flex:2" id="m-submit" onclick="saveLeave()">Submit Request</button>
    </div>
  </div>`,true);
  setTimeout(updateBalChip, 50);
}

function updateBalChip() {
  const empId  = document.getElementById('m-emp')?.value;
  const type   = document.getElementById('m-type')?.value;
  const start  = document.getElementById('m-start')?.value;
  const end    = document.getElementById('m-end')?.value;
  const chip   = document.getElementById('bal-chip');
  const btn    = document.getElementById('m-submit');
  if (!empId||!start||!end||end<start) { chip.style.display='none'; return; }
  const emp = S.employees.find(e=>String(e.id)===empId);
  if (!emp) { chip.style.display='none'; return; }
  const wd   = calcWorkingDays(start, end, emp.Country);
  const used = getUsedDays(emp.id, S.year);
  const tot  = getTotalAllowance(emp, S.year);
  const cf   = getCarryFwd(emp, S.year);
  const base = proRata(emp.AnnualAllowance||25, emp.JoinDate, S.year);
  const rem  = Math.max(0, tot-used);
  const over = type==='Annual Leave' && wd>rem;
  chip.style.display='flex';
  chip.className=`bal-chip ${over?'bal-warn':'bal-ok'}`;
  chip.innerHTML=`<span>${over?'‚ö†Ô∏è':'‚úÖ'}</span><span>${wd} working day${wd!==1?'s':''} ¬∑ ${over?`Exceeds balance of ${rem}d remaining`:`${rem}d remaining`} (Base: ${base}d${cf>0?' + '+cf+'d CF':''})</span>`;
  if(btn){ btn.disabled=over; btn.style.opacity=over?.5:1; btn.style.cursor=over?'not-allowed':'pointer'; }
}

async function saveLeave() {
  const empId  = document.getElementById('m-emp').value;
  const start  = document.getElementById('m-start').value;
  const end    = document.getElementById('m-end').value;
  const type   = document.getElementById('m-type').value;
  const reason = document.getElementById('m-reason').value;
  if (!empId||!start||!end) { alert('Please fill all required fields.'); return; }
  if (end<start) { alert('End date must be on or after start date.'); return; }
  const emp = S.employees.find(e=>String(e.id)===empId);
  if (!emp) { alert('Employee not found.'); return; }
  const wd   = calcWorkingDays(start, end, emp.Country);
  const used = getUsedDays(emp.id, S.year);
  const tot  = getTotalAllowance(emp, S.year);
  if (type==='Annual Leave' && wd>Math.max(0,tot-used)) { alert('Insufficient annual leave balance.'); return; }

  const btn=document.getElementById('m-submit');
  btn.disabled=true; btn.textContent='Submitting‚Ä¶';

  try {
    await createListItem(S.siteId, S.lists.LeaveRequests, {
      Title: `${emp.Title} - ${type} - ${start}`,
      EmployeeId: String(empId),
      EmployeeName: emp.Title,
      LeaveType: type,
      StartDate: start,
      EndDate: end,
      WorkingDays: wd,
      Reason: reason,
      Status: 'Pending',
      AppliedOn: today(),
      AzureObjectId: S.user.id,
    });
    await loadAllData();
    closeModal(); render();
    toast('Leave request submitted');
  } catch(e) {
    btn.disabled=false; btn.textContent='Submit Request';
    toast('Error: '+e.message,'err');
  }
}

function openLeaveDetail(id) {
  const lv = S.leaves.find(l=>String(l.id)===String(id));
  if (!lv) return;
  const emp = S.employees.find(e=>String(e.id)===lv.EmployeeId);
  const cs  = emp?.Country==='UK'?{flag:'üá¨üáß'}:{flag:'üáÆüá≥'};

  const canAct = canApprove() || (S.role==='Manager' && S.employees.some(e=>String(e.id)===lv.EmployeeId&&e.ManagerId===S.user.id));

  const actionBtns = lv.Status==='Pending' && canAct
    ? `<button class="btn-ghost btn-danger" style="flex:1" onclick="setLeaveStatus('${lv.id}','Rejected')">‚úï Reject</button>
       <button class="btn-approve" style="flex:2" onclick="setLeaveStatus('${lv.id}','Approved')">‚úì Approve</button>`
    : lv.Status==='Approved' && canAct
    ? `<button class="btn-ghost btn-danger" style="width:100%" onclick="setLeaveStatus('${lv.id}','Rejected')">Revoke Approval</button>`
    : lv.Status==='Pending' && lv.AzureObjectId===S.user.id
    ? `<button class="btn-ghost btn-danger" style="width:100%" onclick="setLeaveStatus('${lv.id}','Rejected')">Cancel Request</button>`
    : '';

  openModal(`
  <div class="modal-header">
    <div class="modal-title">Leave Request</div>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>
  <div class="modal-body">
    <div style="display:flex;align-items:center;gap:11px;margin-bottom:18px;padding:13px;background:var(--subtle);border-radius:9px">
      ${avHtml(emp?.Title,emp?.Country,42)}
      <div style="flex:1">
        <div style="font-weight:700;font-size:14px;color:var(--navy)">${emp?.Title||'Unknown'}</div>
        <div style="font-size:11px;color:var(--muted)">${cs.flag} ${emp?.Role||''}</div>
      </div>
      ${statusBadge(lv.Status)}
    </div>
    ${[['Leave Type',lv.LeaveType],['Start Date',fmt(lv.StartDate?.split('T')[0])],['End Date',fmt(lv.EndDate?.split('T')[0])],
       ['Working Days',(lv.WorkingDays||0)+' day'+(lv.WorkingDays!=1?'s':'')],
       ['Applied On',fmt(lv.AppliedOn?.split('T')[0])],
       ['Reason',lv.Reason||'‚Äî'],
       lv.ApprovedBy?['Approved By',lv.ApprovedBy]:null,
    ].filter(Boolean).map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:12.5px;color:var(--muted)">${l}</span>
      <span style="font-size:13px;font-weight:500;max-width:60%;text-align:right">${v}</span>
    </div>`).join('')}
    ${actionBtns?`<div class="modal-actions">${actionBtns}</div>`:''}
  </div>`);
}

async function setLeaveStatus(id, status) {
  const btn = document.querySelector('#modal-box button:last-child');
  if(btn){ btn.disabled=true; btn.textContent='Saving‚Ä¶'; }
  try {
    const fields = { Status: status };
    if (status==='Approved') fields.ApprovedBy = S.user.displayName;
    await updateListItem(S.siteId, S.lists.LeaveRequests, id, fields);
    await loadAllData();
    closeModal(); render();
    toast(`Leave ${status.toLowerCase()}`);
  } catch(e) {
    toast('Error: '+e.message,'err');
    if(btn){ btn.disabled=false; btn.textContent=status; }
  }
}

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportSummary() {
  const rows = S.employees.map(emp=>{
    const base=proRata(emp.AnnualAllowance||25,emp.JoinDate,S.year);
    const cf=getCarryFwd(emp,S.year);
    const tot=base+cf;
    const used=getUsedDays(emp.id,S.year);
    const pend=S.leaves.filter(l=>l.EmployeeId===String(emp.id)&&l.Status==='Pending').reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0);
    const rem=Math.max(0,tot-used-pend);
    const sick=S.leaves.filter(l=>l.EmployeeId===String(emp.id)&&l.LeaveType==='Sick Leave'&&l.Status==='Approved'&&new Date(l.StartDate).getFullYear()===S.year).reduce((s,l)=>s+(parseInt(l.WorkingDays)||0),0);
    return{'Name':emp.Title,'Role':emp.Role||'','Country':emp.Country,'Join Date':emp.JoinDate||'',
      'Base Allowance':base,'Carry Forward':cf,'Total Allowance':tot,'Used':used,'Pending':pend,'Remaining':rem,'Sick Days':sick};
  });
  dlCSV(rows,`leave-summary-${S.year}.csv`);
}

function exportDetail() {
  const rows = S.leaves.filter(l=>new Date(l.StartDate).getFullYear()===S.year).map(l=>{
    const emp=S.employees.find(e=>String(e.id)===l.EmployeeId)||{};
    return{'Employee':emp.Title||l.EmployeeName||'','Country':emp.Country||'','Role':emp.Role||'',
      'Type':l.LeaveType,'Start':l.StartDate?.split('T')[0],'End':l.EndDate?.split('T')[0],
      'Working Days':l.WorkingDays||0,'Status':l.Status,'Reason':l.Reason||'',
      'Applied On':l.AppliedOn?.split('T')[0]||'','Approved By':l.ApprovedBy||''};
  });
  dlCSV(rows,`leave-detail-${S.year}.csv`);
}

function dlCSV(rows,filename){
  if(!rows.length){ alert('No data to export.'); return; }
  const h=Object.keys(rows[0]).join(',');
  const b=rows.map(r=>Object.values(r).map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([h+'\n'+b],{type:'text/csv'}));
  a.download=filename; a.click();
  toast(`Exported ${filename}`);
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function init() {
  const signInBtn = document.querySelector('.ms-btn');
  if (signInBtn) { signInBtn.disabled = true; signInBtn.textContent = 'Loading...'; }
  try {
    msalApp = new msal.PublicClientApplication(msalConfig);
    await msalApp.initialize();
    try { await msalApp.handleRedirectPromise(); } catch {}
    if (signInBtn) {
      signInBtn.disabled = false;
      signInBtn.innerHTML = '<div class="ms-logo"><div style="background:#F25022"></div><div style="background:#7FBA00"></div><div style="background:#00A4EF"></div><div style="background:#FFB900"></div></div> Sign in with Microsoft';
    }
    const accounts = msalApp.getAllAccounts();
    if (accounts.length > 0) {
      msalApp.setActiveAccount(accounts[0]);
      await bootApp();
    }
  } catch(e) {
    if (signInBtn) { signInBtn.disabled = false; signInBtn.textContent = 'Sign in with Microsoft'; }
    console.error('Init error:', e);
  }
})();
</script>
</body>
</html>
