<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LeaveSync ‚Äî UK & India Leave Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg:#F7F6F2;--surface:#FFFFFF;--border:#E6E5DF;--text:#1A1A18;
    --muted:#74726A;--subtle:#F0EFE9;--navy:#0C1D3A;--navy2:#1A3356;
    --uk-bg:#EBF3FF;--uk-text:#1251A3;--uk-acc:#2563EB;
    --in-bg:#FFF2E6;--in-text:#B34500;--in-acc:#EA6C00;
    --green:#15803D;--green-bg:#ECFDF5;
    --amber:#92400E;--amber-bg:#FFFBEB;
    --red:#991B1B;--red-bg:#FEF2F2;
    --radius:12px;--shadow:0 1px 4px rgba(0,0,0,.07);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);font-size:14px;min-height:100vh}
  button,input,select,textarea{font-family:inherit;font-size:14px}
  button{cursor:pointer}
  ::-webkit-scrollbar{width:5px}
  ::-webkit-scrollbar-thumb{background:#CCC;border-radius:3px}

  /* Layout */
  #app{display:flex;min-height:100vh}
  #sidebar{width:210px;background:var(--navy);display:flex;flex-direction:column;flex-shrink:0;position:sticky;top:0;height:100vh}
  #main{flex:1;padding:28px 32px;overflow-x:auto}

  /* Sidebar */
  .brand{padding:24px 18px 20px}
  .brand-name{font-family:'Playfair Display',serif;font-size:20px;color:#fff;line-height:1.15}
  .brand-sub{font-size:9px;color:#64748B;letter-spacing:1.2px;text-transform:uppercase;margin-top:5px}
  nav{flex:1;padding:0 10px}
  .nav-btn{display:flex;align-items:center;gap:10px;width:100%;padding:10px 12px;border:none;border-radius:9px;margin-bottom:2px;
    text-align:left;font-size:13px;font-weight:400;background:transparent;color:#94A3B8;transition:all .15s}
  .nav-btn.active{background:rgba(255,255,255,.13);color:#fff;font-weight:600}
  .nav-btn:hover:not(.active){background:rgba(255,255,255,.07);color:#CBD5E1}
  .nav-icon{font-size:14px;width:18px;text-align:center}
  .sidebar-footer{padding:14px 16px;border-top:1px solid rgba(255,255,255,.07)}
  .country-pills{display:flex;gap:7px}
  .cpill{flex:1;padding:7px 6px;background:rgba(255,255,255,.07);border-radius:8px;text-align:center}
  .cpill-flag{font-size:14px}
  .cpill-label{font-size:8.5px;color:#64748B;margin-top:1px}
  .cpill-count{font-size:13px;color:#fff;font-weight:700}

  /* Top bar */
  #topbar{display:flex;justify-content:flex-end;align-items:center;gap:8px;margin-bottom:24px;flex-wrap:wrap}
  .year-btn{padding:5px 13px;border:1.5px solid var(--border);border-radius:18px;font-size:12px;font-weight:600;
    background:#fff;color:var(--muted);transition:all .14s}
  .year-btn.active{border-color:#2563EB;background:#EBF3FF;color:#1251A3}

  /* Buttons */
  .btn-primary{padding:8px 16px;border:none;border-radius:9px;font-weight:600;color:#fff;
    background:linear-gradient(135deg,var(--navy),var(--navy2));transition:opacity .15s,transform .15s}
  .btn-primary:hover{opacity:.88;transform:translateY(-1px)}
  .btn-ghost{padding:8px 16px;border:1.5px solid var(--border);border-radius:9px;font-weight:600;
    background:#fff;color:var(--muted);transition:all .15s}
  .btn-ghost:hover{border-color:#94A3B8;color:var(--text)}
  .btn-sm{padding:6px 12px;font-size:12px}
  .btn-danger{border-color:#FCA5A5!important;color:#EF4444!important}

  /* Cards */
  .card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card:hover{box-shadow:0 4px 18px rgba(0,0,0,.09)}
  .card-header{display:flex;justify-content:space-between;align-items:center;padding:13px 16px;border-bottom:1px solid var(--border)}
  .card-title{font-size:14px;font-weight:700;color:var(--navy)}

  /* Page header */
  .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:22px}
  .page-title{font-family:'Playfair Display',serif;font-size:26px;color:var(--navy);letter-spacing:-.3px}
  .page-sub{font-size:12px;color:var(--muted);margin-top:3px}

  /* KPI grid */
  .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
  .kpi{background:var(--surface);border-radius:var(--radius);padding:18px 16px 15px;box-shadow:var(--shadow);border-top:3px solid transparent;transition:box-shadow .18s,transform .18s;cursor:default}
  .kpi:hover{box-shadow:0 6px 22px rgba(0,0,0,.09);transform:translateY(-1px)}
  .kpi-icon{font-size:22px;margin-bottom:8px}
  .kpi-val{font-family:'Playfair Display',serif;font-size:30px;font-weight:700;color:var(--navy);line-height:1}
  .kpi-label{font-size:13px;font-weight:600;color:var(--text);margin-top:5px}
  .kpi-sub{font-size:11px;color:var(--muted);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  /* Country row */
  .country-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
  .country-card{background:var(--surface);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}

  /* Progress bar */
  .progress-track{background:var(--subtle);border-radius:4px;height:6px;overflow:hidden}
  .progress-fill{height:100%;border-radius:4px;transition:width .5s ease}

  /* Tables */
  .tbl{width:100%;border-collapse:collapse}
  .tbl th{padding:8px 12px;font-size:9.5px;font-weight:700;color:var(--muted);text-align:left;text-transform:uppercase;letter-spacing:.5px;background:var(--subtle)}
  .tbl td{padding:9px 12px;border-bottom:1px solid var(--border)}
  .tbl tr:last-child td{border-bottom:none}
  .tbl tr:hover td{background:#F9F8F4}
  .tbl-click tr{cursor:pointer}

  /* Badges */
  .badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:18px;font-size:10.5px;font-weight:700}
  .badge-dot{width:5px;height:5px;border-radius:50%}
  .badge-approved{background:var(--green-bg);color:var(--green)}
  .badge-pending{background:var(--amber-bg);color:var(--amber)}
  .badge-rejected{background:var(--red-bg);color:var(--red)}
  .badge-uk{background:var(--uk-bg);color:var(--uk-text)}
  .badge-india{background:var(--in-bg);color:var(--in-text)}

  /* Avatar */
  .av{display:flex;align-items:center;justify-content:center;font-weight:700;border-radius:9px;flex-shrink:0}

  /* Mini stats */
  .mini-grid{display:grid;gap:5px}
  .mini{background:var(--subtle);border-radius:7px;padding:6px 8px;text-align:center}
  .mini-val{font-size:13px;font-weight:600;color:var(--navy)}
  .mini-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-top:1px}

  /* Employee grid */
  .emp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(275px,1fr));gap:13px}
  .emp-card{background:var(--surface);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);transition:box-shadow .18s,transform .18s}
  .emp-card:hover{box-shadow:0 6px 20px rgba(0,0,0,.09);transform:translateY(-1px)}

  /* Filters */
  .filters{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
  .seg{display:flex;gap:3px;background:var(--subtle);border-radius:9px;padding:3px}
  .seg-btn{padding:5px 11px;border:none;border-radius:7px;font-size:11.5px;font-weight:600;background:transparent;color:var(--muted);transition:all .14s}
  .seg-btn.active{background:#fff;color:var(--navy);box-shadow:0 1px 4px rgba(0,0,0,.08)}
  .inp{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;outline:none;color:var(--text);background:#fff;transition:border .15s}
  .inp:focus{border-color:#2563EB}
  .inp-sm{padding:7px 10px;font-size:12px}

  /* Modal */
  .overlay{position:fixed;inset:0;background:rgba(12,29,58,.52);backdrop-filter:blur(5px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fi .16s ease}
  .modal{background:var(--surface);border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow:auto;box-shadow:0 24px 60px rgba(0,0,0,.24);animation:fu .26s ease}
  .modal-lg{max-width:560px}
  .modal-header{display:flex;justify-content:space-between;align-items:center;padding:18px 22px;border-bottom:1px solid var(--border)}
  .modal-title{font-family:'Playfair Display',serif;font-size:19px;color:var(--navy)}
  .modal-close{border:none;background:var(--subtle);color:var(--muted);width:28px;height:28px;border-radius:7px;font-size:13px;display:flex;align-items:center;justify-content:center}
  .modal-body{padding:22px}
  .field{margin-bottom:13px}
  .field-label{display:block;font-size:10.5px;font-weight:700;color:var(--muted);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:11px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
  .cf-box{background:var(--subtle);border-radius:9px;padding:13px;margin-bottom:14px}
  .cf-title{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:9px}
  .modal-actions{display:flex;gap:9px;margin-top:18px}
  .check-row{display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-bottom:9px}

  /* Balance chip */
  .bal-chip{padding:9px 12px;border-radius:8px;display:flex;align-items:center;gap:8px;margin-bottom:13px;font-size:12.5px;font-weight:500}
  .bal-ok{background:var(--green-bg);color:var(--green)}
  .bal-warn{background:var(--red-bg);color:var(--red)}

  /* Calendar */
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr)}
  .cal-hdr{padding:9px 0;text-align:center;font-size:9.5px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;background:var(--subtle)}
  .cal-day{min-height:82px;padding:5px;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
  .cal-day.weekend{background:#FAFAF6}
  .cal-blank{min-height:82px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:#FAFAF6}
  .cal-num{width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:12px;margin-bottom:3px}
  .cal-today .cal-num{background:var(--navy);color:#fff;font-weight:700}
  .cal-tag{font-size:7.5px;padding:1px 3px;border-radius:3px;margin-bottom:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  /* Reports bars */
  .rep-bar-track{background:var(--subtle);border-radius:5px;height:10px;overflow:hidden}
  .rep-bar-fill{height:100%;border-radius:5px;transition:width .6s ease}

  /* Toast */
  .toast{position:fixed;bottom:22px;right:26px;padding:10px 18px;border-radius:10px;color:#fff;font-size:13px;font-weight:500;
    box-shadow:0 8px 28px rgba(0,0,0,.22);z-index:9999;display:flex;align-items:center;gap:7px;animation:fi .16s ease}
  .toast-ok{background:var(--navy)}
  .toast-err{background:var(--red)}

  /* Utils */
  .link{color:#2563EB;cursor:pointer;font-size:11.5px;font-weight:500}
  .link:hover{text-decoration:underline}
  .section-two{display:grid;grid-template-columns:370px 1fr;gap:14px}

  @keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  @keyframes fi{from{opacity:0}to{opacity:1}}
  @keyframes tab-in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .tab-content{animation:tab-in .24s ease both}

  /* Responsive */
  @media(max-width:900px){
    #sidebar{width:56px}
    .brand,.brand-sub,.nav-btn span:last-child,.sidebar-footer{display:none}
    .nav-btn{justify-content:center;padding:12px 0}
    .nav-icon{width:auto}
    #main{padding:16px}
    .kpi-grid{grid-template-columns:1fr 1fr}
    .country-row{grid-template-columns:1fr}
    .section-two{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="brand">
      <div class="brand-name">Leave<br>Sync</div>
      <div class="brand-sub">UK ¬∑ India Manager</div>
    </div>
    <nav id="nav"></nav>
    <div class="sidebar-footer">
      <div class="country-pills">
        <div class="cpill"><div class="cpill-flag">üá¨üáß</div><div class="cpill-label">UK</div><div class="cpill-count" id="pill-uk">0</div></div>
        <div class="cpill"><div class="cpill-flag">üáÆüá≥</div><div class="cpill-label">India</div><div class="cpill-count" id="pill-india">0</div></div>
      </div>
    </div>
  </div>

  <div id="main">
    <div id="topbar">
      <span style="font-size:12px;color:var(--muted);font-weight:500">Year:</span>
      <button class="year-btn" data-year="2024">2024</button>
      <button class="year-btn" data-year="2025">2025</button>
      <button class="year-btn" data-year="2026">2026</button>
      <button class="btn-primary btn-sm" id="btn-apply" style="margin-left:6px">+ Apply Leave</button>
      <button class="btn-ghost btn-sm" id="btn-add-emp">+ Add Employee</button>
    </div>
    <div id="content"></div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast" style="display:none"></div>

<!-- Modals -->
<div id="modal-overlay" class="overlay" style="display:none" onclick="if(event.target===this)closeModal()">
  <div id="modal-box" class="modal"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PUBLIC_HOLIDAYS = {
  UK:{
    2024:[{d:"2024-01-01",n:"New Year's Day"},{d:"2024-03-29",n:"Good Friday"},{d:"2024-04-01",n:"Easter Monday"},{d:"2024-05-06",n:"Early May Bank Holiday"},{d:"2024-05-27",n:"Spring Bank Holiday"},{d:"2024-08-26",n:"Summer Bank Holiday"},{d:"2024-12-25",n:"Christmas Day"},{d:"2024-12-26",n:"Boxing Day"}],
    2025:[{d:"2025-01-01",n:"New Year's Day"},{d:"2025-04-18",n:"Good Friday"},{d:"2025-04-21",n:"Easter Monday"},{d:"2025-05-05",n:"Early May Bank Holiday"},{d:"2025-05-26",n:"Spring Bank Holiday"},{d:"2025-08-25",n:"Summer Bank Holiday"},{d:"2025-12-25",n:"Christmas Day"},{d:"2025-12-26",n:"Boxing Day"}],
    2026:[{d:"2026-01-01",n:"New Year's Day"},{d:"2026-04-03",n:"Good Friday"},{d:"2026-04-06",n:"Easter Monday"},{d:"2026-05-04",n:"Early May Bank Holiday"},{d:"2026-05-25",n:"Spring Bank Holiday"},{d:"2026-08-31",n:"Summer Bank Holiday"},{d:"2026-12-25",n:"Christmas Day"},{d:"2026-12-28",n:"Boxing Day (substitute)"}],
  },
  India:{
    2024:[{d:"2024-01-26",n:"Republic Day"},{d:"2024-03-25",n:"Holi"},{d:"2024-04-14",n:"Dr. Ambedkar Jayanti"},{d:"2024-04-19",n:"Good Friday"},{d:"2024-08-15",n:"Independence Day"},{d:"2024-10-02",n:"Gandhi Jayanti"},{d:"2024-10-12",n:"Dussehra"},{d:"2024-11-01",n:"Diwali"},{d:"2024-11-15",n:"Guru Nanak Jayanti"},{d:"2024-12-25",n:"Christmas Day"}],
    2025:[{d:"2025-01-26",n:"Republic Day"},{d:"2025-03-14",n:"Holi"},{d:"2025-04-14",n:"Dr. Ambedkar Jayanti"},{d:"2025-04-18",n:"Good Friday"},{d:"2025-05-12",n:"Buddha Purnima"},{d:"2025-08-15",n:"Independence Day"},{d:"2025-08-27",n:"Janmashtami"},{d:"2025-10-02",n:"Gandhi Jayanti"},{d:"2025-10-20",n:"Diwali"},{d:"2025-11-05",n:"Guru Nanak Jayanti"},{d:"2025-12-25",n:"Christmas Day"}],
    2026:[{d:"2026-01-26",n:"Republic Day"},{d:"2026-03-04",n:"Holi"},{d:"2026-04-14",n:"Dr. Ambedkar Jayanti"},{d:"2026-04-03",n:"Good Friday"},{d:"2026-08-15",n:"Independence Day"},{d:"2026-10-02",n:"Gandhi Jayanti"},{d:"2026-10-19",n:"Diwali"},{d:"2026-12-25",n:"Christmas Day"}],
  }
};

const LEAVE_TYPES = ["Annual Leave","Sick Leave","Maternity/Paternity Leave","Compassionate Leave","Study Leave","Unpaid Leave"];
const DEF_ALLOW = {UK:25,India:21};

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  tab: 'dashboard',
  year: new Date().getFullYear(),
  employees: [],
  leaves: [],
  calMonth: new Date().getMonth(),
  calYear: new Date().getFullYear(),
  reportView: 'summary',
  leavesStatus: 'All',
  leavesCountry: 'All',
  leavesType: 'All',
  leavesSearch: '',
  empCountry: 'All',
  empSearch: '',
  holYear: null,
};

// ‚îÄ‚îÄ‚îÄ Persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function persist(){
  try{
    localStorage.setItem('ls_employees', JSON.stringify(state.employees));
    localStorage.setItem('ls_leaves',    JSON.stringify(state.leaves));
  }catch(e){}
}

function hydrate(){
  try{
    const e=localStorage.getItem('ls_employees');
    const l=localStorage.getItem('ls_leaves');
    if(e) state.employees=JSON.parse(e);
    else  state.employees=seedEmployees();
    if(l) state.leaves=JSON.parse(l);
    else  state.leaves=seedLeaves();
  }catch{
    state.employees=seedEmployees();
    state.leaves=seedLeaves();
  }
}

function seedEmployees(){
  return [
    {id:'e1',name:'Alex Castle',   role:'Sales Director',      country:'UK',   allowance:25,joinDate:'2022-03-01',cfEnabled:true, cfMax:5},
    {id:'e2',name:'Priya Sharma',  role:'Data Analyst',        country:'India',allowance:21,joinDate:'2023-06-15',cfEnabled:true, cfMax:5},
    {id:'e3',name:'James Wright',  role:'Solutions Architect', country:'UK',   allowance:28,joinDate:'2021-01-10',cfEnabled:true, cfMax:5},
    {id:'e4',name:'Anita Patel',   role:'BI Developer',        country:'India',allowance:21,joinDate:'2024-09-01',cfEnabled:false,cfMax:5},
    {id:'e5',name:'Tom Henderson', role:'Project Manager',     country:'UK',   allowance:25,joinDate:'2025-02-01',cfEnabled:true, cfMax:3},
    {id:'e6',name:'Deepa Nair',    role:'QA Engineer',         country:'India',allowance:21,joinDate:'2023-11-15',cfEnabled:true, cfMax:5},
  ];
}

function seedLeaves(){
  return [
    {id:'l1',empId:'e1',type:'Annual Leave',start:'2025-03-10',end:'2025-03-14',days:5,reason:'Family holiday',  status:'Approved',applied:'2025-02-15'},
    {id:'l2',empId:'e2',type:'Sick Leave',  start:'2025-02-03',end:'2025-02-04',days:2,reason:'Unwell',          status:'Approved',applied:'2025-02-03'},
    {id:'l3',empId:'e3',type:'Annual Leave',start:'2025-04-22',end:'2025-04-25',days:4,reason:'Easter break',    status:'Pending', applied:'2025-02-10'},
    {id:'l4',empId:'e4',type:'Annual Leave',start:'2025-10-20',end:'2025-10-22',days:1,reason:'Diwali',          status:'Approved',applied:'2025-09-01'},
    {id:'l5',empId:'e5',type:'Annual Leave',start:'2025-06-02',end:'2025-06-06',days:5,reason:'Summer break',    status:'Pending', applied:'2025-03-01'},
    {id:'l6',empId:'e6',type:'Sick Leave',  start:'2025-01-20',end:'2025-01-21',days:2,reason:'Fever',           status:'Approved',applied:'2025-01-20'},
    {id:'l7',empId:'e1',type:'Annual Leave',start:'2024-12-23',end:'2024-12-27',days:3,reason:'Christmas',       status:'Approved',applied:'2024-11-01'},
    {id:'l8',empId:'e3',type:'Annual Leave',start:'2024-08-05',end:'2024-08-16',days:10,reason:'Summer holiday', status:'Approved',applied:'2024-06-01'},
  ];
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function today(){ return new Date().toISOString().split('T')[0]; }
function uid(){ return Math.random().toString(36).slice(2,9); }

function isWeekend(ds){
  const d=new Date(ds); return d.getDay()===0||d.getDay()===6;
}

function isHoliday(ds,country){
  const yr=parseInt(ds.slice(0,4));
  return (PUBLIC_HOLIDAYS[country]?.[yr]||[]).some(h=>h.d===ds);
}

function calcWorkingDays(start,end,country){
  if(!start||!end||end<start) return 0;
  let n=0;
  const cur=new Date(start), last=new Date(end);
  while(cur<=last){
    const ds=cur.toISOString().split('T')[0];
    if(!isWeekend(ds)&&!isHoliday(ds,country)) n++;
    cur.setDate(cur.getDate()+1);
  }
  return n;
}

function proRata(allowance,joinDate,year){
  const join=new Date(joinDate);
  if(join.getFullYear()<year) return allowance;
  if(join.getFullYear()>year) return 0;
  const yearEnd=new Date(year,11,31);
  const totalDays=(yearEnd-new Date(year,0,1))/864e5+1;
  const rem=(yearEnd-join)/864e5+1;
  return Math.round(rem/totalDays*allowance);
}

function getCarryFwd(emp,year){
  if(!emp.cfEnabled) return 0;
  const py=year-1;
  const pyBase=proRata(emp.allowance,emp.joinDate,py);
  const pyUsed=state.leaves
    .filter(l=>l.empId===emp.id&&l.status!=='Rejected'&&new Date(l.start).getFullYear()===py)
    .reduce((s,l)=>s+(l.days||0),0);
  return Math.min(Math.max(0,pyBase-pyUsed), emp.cfMax||5);
}

function getTotalAllowance(emp,year){
  return proRata(emp.allowance,emp.joinDate,year)+getCarryFwd(emp,year);
}

function getUsedDays(empId,year){
  return state.leaves
    .filter(l=>l.empId===empId&&l.status!=='Rejected'&&new Date(l.start).getFullYear()===year)
    .reduce((s,l)=>s+(l.days||0),0);
}

function fmt(ds){
  if(!ds) return '‚Äî';
  return new Date(ds).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
}

function fmtWday(ds){
  return new Date(ds).toLocaleDateString('en-GB',{weekday:'long'});
}

function greet(){
  const h=new Date().getHours();
  return h<12?'morning':h<17?'afternoon':'evening';
}

// ‚îÄ‚îÄ‚îÄ Avatar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function avHtml(name,country,size=34){
  const cs=country==='UK'?{bg:'#DBEAFE',text:'#1251A3',acc:'#2563EB'}:{bg:'#FFEDD5',text:'#B34500',acc:'#EA6C00'};
  const ini=(name||'?').split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
  const r=Math.round(size*0.26);
  return `<div class="av" style="width:${size}px;height:${size}px;border-radius:${r}px;font-size:${Math.round(size*.36)}px;background:${cs.bg};color:${cs.text};border:1.5px solid ${cs.acc}44">${ini}</div>`;
}

function statusBadge(status){
  const map={Approved:'approved',Pending:'pending',Rejected:'rejected'};
  const dot={Approved:'#22C55E',Pending:'#F59E0B',Rejected:'#EF4444'};
  return `<span class="badge badge-${map[status]||'pending'}"><span class="badge-dot" style="background:${dot[status]||dot.Pending}"></span>${status}</span>`;
}

function countryBadge(country){
  const cls=country==='UK'?'badge-uk':'badge-india';
  const flag=country==='UK'?'üá¨üáß':'üáÆüá≥';
  return `<span class="badge ${cls}">${flag} ${country}</span>`;
}

// ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer=null;
function toast(msg,type='ok'){
  const el=document.getElementById('toast');
  el.className=`toast toast-${type}`;
  el.innerHTML=`${type==='ok'?'‚úì':'‚úï'} ${msg}`;
  el.style.display='flex';
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.style.display='none',3200);
}

// ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(html,large=false){
  const box=document.getElementById('modal-box');
  box.className='modal'+(large?' modal-lg':'');
  box.innerHTML=html;
  document.getElementById('modal-overlay').style.display='flex';
}
function closeModal(){
  document.getElementById('modal-overlay').style.display='none';
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  updateSidebar();
  updateTopbar();
  updatePills();
  const el=document.getElementById('content');
  el.innerHTML='';
  const wrap=document.createElement('div');
  wrap.className='tab-content';
  wrap.innerHTML=renderTab();
  el.appendChild(wrap);
  attachTabEvents();
}

function updateSidebar(){
  const tabs=[
    {key:'dashboard',label:'Dashboard',icon:'‚óà'},
    {key:'employees',label:'Employees',icon:'‚óâ'},
    {key:'leaves',   label:'Requests', icon:'‚óé'},
    {key:'calendar', label:'Calendar', icon:'‚¨°'},
    {key:'holidays', label:'Holidays', icon:'‚óá'},
    {key:'reports',  label:'Reports',  icon:'‚óÜ'},
  ];
  document.getElementById('nav').innerHTML=tabs.map(t=>`
    <button class="nav-btn${state.tab===t.key?' active':''}" data-tab="${t.key}">
      <span class="nav-icon">${t.icon}</span>
      <span>${t.label}</span>
    </button>`).join('');
  document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>{state.tab=b.dataset.tab;render();}));
}

function updateTopbar(){
  document.querySelectorAll('.year-btn').forEach(b=>{
    b.classList.toggle('active',parseInt(b.dataset.year)===state.year);
    b.onclick=()=>{state.year=parseInt(b.dataset.year);render();};
  });
}

function updatePills(){
  document.getElementById('pill-uk').textContent=state.employees.filter(e=>e.country==='UK').length;
  document.getElementById('pill-india').textContent=state.employees.filter(e=>e.country==='India').length;
}

function renderTab(){
  switch(state.tab){
    case 'dashboard': return renderDashboard();
    case 'employees': return renderEmployees();
    case 'leaves':    return renderLeaves();
    case 'calendar':  return renderCalendar();
    case 'holidays':  return renderHolidays();
    case 'reports':   return renderReports();
    default:          return renderDashboard();
  }
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard(){
  const t=today();
  const pending=state.leaves.filter(l=>l.status==='Pending');
  const onLeave=state.leaves.filter(l=>l.status==='Approved'&&l.start<=t&&l.end>=t);
  const yrLeaves=state.leaves.filter(l=>new Date(l.start).getFullYear()===state.year);

  const totUsed=co=>state.employees.filter(e=>e.country===co).reduce((s,e)=>s+getUsedDays(e.id,state.year),0);
  const totAllow=co=>state.employees.filter(e=>e.country===co).reduce((s,e)=>s+getTotalAllowance(e,state.year),0);

  const onNames=onLeave.slice(0,2).map(l=>{const e=state.employees.find(x=>x.id===l.empId);return e?.name?.split(' ')[0]||'';}).filter(Boolean);

  let cRows='';
  for(const co of ['UK','India']){
    const cs=co==='UK'?{flag:'üá¨üáß',acc:'var(--uk-acc)',text:'var(--uk-text)'}:{flag:'üáÆüá≥',acc:'var(--in-acc)',text:'var(--in-text)'};
    const used=totUsed(co),allow=totAllow(co);
    const pct=allow>0?Math.min(100,Math.round(used/allow*100)):0;
    const emps=state.employees.filter(e=>e.country===co);
    const pend=state.leaves.filter(l=>l.status==='Pending'&&emps.some(e=>e.id===l.empId)).length;
    cRows+=`<div class="country-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div style="display:flex;gap:10px;align-items:center">
          <span style="font-size:26px">${cs.flag}</span>
          <div>
            <div style="font-size:15px;font-weight:700;color:var(--navy)">${co==='UK'?'United Kingdom':'India'}</div>
            <div style="font-size:11px;color:var(--muted)">${emps.length} employees ¬∑ Default ${DEF_ALLOW[co]}d/yr</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:10px;color:var(--muted)">Used / Allowed</div>
          <div style="font-size:20px;font-weight:700;color:var(--navy)">${used}<span style="font-size:12px;color:var(--muted);font-weight:400"> / ${allow}</span></div>
        </div>
      </div>
      <div class="progress-track" style="margin-bottom:8px">
        <div class="progress-fill" style="width:${pct}%;background:linear-gradient(90deg,${cs.acc},${cs.text})"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted)">
        <span>${pct}% utilised</span><span>${pend} pending</span>
      </div>
    </div>`;
  }

  const recentRows=([...state.leaves].sort((a,b)=>(b.applied||'').localeCompare(a.applied||'')).slice(0,8).map(l=>{
    const emp=state.employees.find(e=>e.id===l.empId);
    const flag=emp?.country==='UK'?'üá¨üáß':'üáÆüá≥';
    return `<tr onclick="openLeaveDetail('${l.id}')" style="cursor:pointer">
      <td>${avHtml(emp?.name,emp?.country,28)}<span style="margin-left:8px;font-size:13px;font-weight:600">${emp?.name||'‚Äî'}</span><div style="font-size:10px;color:var(--muted);margin-left:36px">${flag} ${emp?.role||''}</div></td>
      <td style="color:var(--muted);font-size:11px">${l.type}</td>
      <td style="font-size:12px">${fmt(l.start)}</td>
      <td style="font-size:14px;font-weight:700;color:var(--navy)">${l.days}d</td>
      <td>${statusBadge(l.status)}</td>
    </tr>`;
  }).join(''));

  const pendRows=pending.slice(0,5).map(l=>{
    const emp=state.employees.find(e=>e.id===l.empId);
    return `<div onclick="openLeaveDetail('${l.id}')" style="display:flex;justify-content:space-between;align-items:center;padding:9px 14px;cursor:pointer;border-bottom:1px solid var(--border)" class="tbl-row-hover">
      <div style="display:flex;gap:9px;align-items:center">
        ${avHtml(emp?.name,emp?.country)}
        <div>
          <div style="font-size:13px;font-weight:600">${emp?.name||'‚Äî'}</div>
          <div style="font-size:10px;color:var(--muted)">${l.type} ¬∑ ${l.days}d</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--muted)">${fmt(l.start)}</div>
        ${statusBadge(l.status)}
      </div>
    </div>`;
  }).join('');

  return `
  <div class="page-header">
    <div><div class="page-title">Good ${greet()}</div>
    <div class="page-sub">Team leave overview ¬∑ ${state.year}</div></div>
  </div>
  <div class="kpi-grid">
    <div class="kpi" style="border-top-color:#2563EB">
      <div class="kpi-icon">üë•</div><div class="kpi-val">${state.employees.length}</div>
      <div class="kpi-label">Employees</div>
      <div class="kpi-sub">${state.employees.filter(e=>e.country==='UK').length} UK ¬∑ ${state.employees.filter(e=>e.country==='India').length} India</div>
    </div>
    <div class="kpi" style="border-top-color:#F59E0B;cursor:pointer" onclick="state.tab='leaves';render()">
      <div class="kpi-icon">‚è≥</div><div class="kpi-val">${pending.length}</div>
      <div class="kpi-label">Pending Approval</div><div class="kpi-sub">Awaiting action</div>
    </div>
    <div class="kpi" style="border-top-color:#7C3AED">
      <div class="kpi-icon">‚úàÔ∏è</div><div class="kpi-val">${onLeave.length}</div>
      <div class="kpi-label">On Leave Today</div>
      <div class="kpi-sub">${onLeave.length?onNames.join(', ')+(onLeave.length>2?` +${onLeave.length-2}`:''):'Nobody away'}</div>
    </div>
    <div class="kpi" style="border-top-color:#059669">
      <div class="kpi-icon">üìã</div><div class="kpi-val">${yrLeaves.length}</div>
      <div class="kpi-label">Requests ${state.year}</div>
      <div class="kpi-sub">${yrLeaves.filter(l=>l.status==='Approved').length} approved</div>
    </div>
  </div>
  <div class="country-row">${cRows}</div>
  <div class="section-two">
    <div class="card">
      <div class="card-header"><div class="card-title">Pending Requests</div><span class="link" onclick="state.tab='leaves';render()">View all ‚Üí</span></div>
      ${pending.length===0?'<div style="padding:32px;text-align:center;color:var(--muted)"><div style="font-size:28px;margin-bottom:6px">üì≠</div>No pending requests</div>':pendRows}
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">Recent Activity</div><span class="link" onclick="state.tab='leaves';render()">View all ‚Üí</span></div>
      <table class="tbl tbl-click"><thead><tr><th>Employee</th><th>Type</th><th>Start</th><th>Days</th><th>Status</th></tr></thead>
      <tbody>${recentRows}</tbody></table>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ EMPLOYEES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEmployees(){
  const filtered=state.employees.filter(e=>
    (state.empCountry==='All'||e.country===state.empCountry)&&
    e.name.toLowerCase().includes(state.empSearch.toLowerCase())
  );

  const cards=filtered.map(emp=>{
    const base=proRata(emp.allowance,emp.joinDate,state.year);
    const cf=getCarryFwd(emp,state.year);
    const tot=base+cf;
    const used=getUsedDays(emp.id,state.year);
    const pend=state.leaves.filter(l=>l.empId===emp.id&&l.status==='Pending').reduce((s,l)=>s+(l.days||0),0);
    const rem=Math.max(0,tot-used-pend);
    const pct=tot>0?Math.min(100,Math.round(used/tot*100)):0;
    const barColor=pct>85?'#EF4444':emp.country==='UK'?'var(--uk-acc)':'var(--in-acc)';
    const isNew=new Date(emp.joinDate).getFullYear()===state.year&&new Date(emp.joinDate)>new Date(state.year,0,1);
    return `<div class="emp-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div style="display:flex;gap:9px;align-items:center">
          ${avHtml(emp.name,emp.country,40)}
          <div>
            <div style="font-weight:700;font-size:13.5px;color:var(--navy)">${emp.name}</div>
            <div style="font-size:10.5px;color:var(--muted)">${emp.role}</div>
          </div>
        </div>
        ${countryBadge(emp.country)}
      </div>
      <div class="mini-grid grid-3" style="margin-bottom:8px">
        <div class="mini"><div class="mini-val">${base}d</div><div class="mini-lbl">Base</div></div>
        <div class="mini"><div class="mini-val" style="color:${cf>0?'#15803D':'var(--muted)'}">${cf>0?'+'+cf+'d':'‚Äî'}</div><div class="mini-lbl">Carry Fwd</div></div>
        <div class="mini"><div class="mini-val" style="font-weight:700">${tot}d</div><div class="mini-lbl">Total</div></div>
      </div>
      <div class="mini-grid grid-3" style="margin-bottom:9px">
        <div class="mini"><div class="mini-val">${used}d</div><div class="mini-lbl">Used</div></div>
        <div class="mini"><div class="mini-val" style="color:${pend>0?'#D97706':'var(--muted)'}">${pend>0?pend+'d':'‚Äî'}</div><div class="mini-lbl">Pending</div></div>
        <div class="mini"><div class="mini-val" style="color:${rem<3?'#EF4444':rem<6?'#D97706':'var(--navy)'}">${rem}d</div><div class="mini-lbl">Remaining</div></div>
      </div>
      <div class="progress-track" style="margin-bottom:8px">
        <div class="progress-fill" style="width:${pct}%;background:${barColor}"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:9.5px;color:var(--muted);margin-bottom:12px">
        <span>${pct}% used${isNew?' ¬∑ Pro-rata':''}</span>
        <span>${emp.cfEnabled?'CF max: '+emp.cfMax+'d':'No carry fwd'}</span>
      </div>
      <button class="btn-ghost btn-sm btn-danger" onclick="removeEmployee('${emp.id}')" style="width:100%">Remove</button>
    </div>`;
  }).join('');

  return `
  <div class="page-header">
    <div><div class="page-title">Employees</div><div class="page-sub">${state.employees.length} team members</div></div>
    <button class="btn-primary btn-sm" onclick="openAddEmployee()">+ Add Employee</button>
  </div>
  <div class="filters">
    <input class="inp inp-sm" id="emp-search" value="${state.empSearch}" placeholder="Search employees‚Ä¶" style="width:180px" oninput="state.empSearch=this.value;renderInPlace()">
    <div class="seg">
      ${['All','UK','India'].map(o=>`<button class="seg-btn${state.empCountry===o?' active':''}" onclick="state.empCountry='${o}';renderInPlace()">${o}</button>`).join('')}
    </div>
  </div>
  <div class="emp-grid">${cards||'<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">No employees found</div>'}</div>`;
}

// ‚îÄ‚îÄ‚îÄ LEAVES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLeaves(){
  const filtered=state.leaves.filter(l=>{
    const emp=state.employees.find(e=>e.id===l.empId);
    return (state.leavesStatus==='All'||l.status===state.leavesStatus)
      &&(state.leavesCountry==='All'||emp?.country===state.leavesCountry)
      &&(state.leavesType==='All'||l.type===state.leavesType)
      &&(state.leavesSearch===''||emp?.name?.toLowerCase().includes(state.leavesSearch.toLowerCase()));
  }).sort((a,b)=>(b.applied||'').localeCompare(a.applied||''));

  const counts={All:state.leaves.length,Pending:state.leaves.filter(l=>l.status==='Pending').length,
    Approved:state.leaves.filter(l=>l.status==='Approved').length,Rejected:state.leaves.filter(l=>l.status==='Rejected').length};

  const rows=filtered.map(l=>{
    const emp=state.employees.find(e=>e.id===l.empId);
    const flag=emp?.country==='UK'?'üá¨üáß':'üáÆüá≥';
    return `<tr onclick="openLeaveDetail('${l.id}')" style="cursor:pointer">
      <td>
        <div style="display:flex;gap:8px;align-items:center">
          ${avHtml(emp?.name,emp?.country,28)}
          <div>
            <div style="font-size:13px;font-weight:600">${emp?.name||'‚Äî'}</div>
            <div style="font-size:10px;color:var(--muted)">${flag} ${emp?.role||''}</div>
          </div>
        </div>
      </td>
      <td style="font-size:11px;color:var(--muted)">${l.type}</td>
      <td style="font-size:12px">${fmt(l.start)}</td>
      <td style="font-size:12px">${fmt(l.end)}</td>
      <td style="font-size:14px;font-weight:700;color:var(--navy)">${l.days}d</td>
      <td style="font-size:11px;color:var(--muted)">${fmt(l.applied)}</td>
      <td>${statusBadge(l.status)}</td>
      <td style="color:var(--muted)">‚Ä∫</td>
    </tr>`;
  }).join('');

  return `
  <div class="page-header">
    <div><div class="page-title">Leave Requests</div><div class="page-sub">${counts.Pending} pending approval</div></div>
    <button class="btn-primary btn-sm" onclick="openApplyLeave()">+ Apply Leave</button>
  </div>
  <div class="filters">
    <input class="inp inp-sm" id="lv-search" value="${state.leavesSearch}" placeholder="Search employee‚Ä¶" style="width:160px" oninput="state.leavesSearch=this.value;renderInPlace()">
    <div class="seg">
      ${['All','Pending','Approved','Rejected'].map(s=>`<button class="seg-btn${state.leavesStatus===s?' active':''}" onclick="state.leavesStatus='${s}';renderInPlace()">
        ${s}${s!=='All'?`<span style="margin-left:4px;font-size:9.5px;background:${state.leavesStatus===s?'var(--subtle)':'transparent'};padding:1px 4px;border-radius:7px;color:var(--muted)">${counts[s]}</span>`:''}</button>`).join('')}
    </div>
    <select class="inp inp-sm" style="width:auto" onchange="state.leavesCountry=this.value;renderInPlace()">
      <option value="All"${state.leavesCountry==='All'?' selected':''}>All Countries</option>
      <option value="UK"${state.leavesCountry==='UK'?' selected':''}>üá¨üáß UK</option>
      <option value="India"${state.leavesCountry==='India'?' selected':''}>üáÆüá≥ India</option>
    </select>
    <select class="inp inp-sm" style="width:auto" onchange="state.leavesType=this.value;renderInPlace()">
      <option value="All"${state.leavesType==='All'?' selected':''}>All Types</option>
      ${LEAVE_TYPES.map(t=>`<option value="${t}"${state.leavesType===t?' selected':''}>${t}</option>`).join('')}
    </select>
  </div>
  <div class="card" style="overflow:hidden">
    ${filtered.length===0
      ?'<div style="padding:40px;text-align:center;color:var(--muted)"><div style="font-size:28px;margin-bottom:6px">üì≠</div>No requests match your filters</div>'
      :`<table class="tbl tbl-click"><thead><tr>
          <th>Employee</th><th>Type</th><th>Start</th><th>End</th><th>Days</th><th>Applied</th><th>Status</th><th></th>
        </tr></thead><tbody>${rows}</tbody></table>`
    }
  </div>
  <div style="font-size:11px;color:var(--muted);margin-top:8px;text-align:right">${filtered.length} record${filtered.length!==1?'s':''}</div>`;
}

// ‚îÄ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCalendar(){
  const vm=state.calMonth, vy=state.calYear;
  const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
  const DAYS=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const dim=new Date(vy,vm+1,0).getDate();
  const blanks=(new Date(vy,vm,1).getDay()+6)%7;
  const n=new Date();
  const isToday=(d)=>d===n.getDate()&&vm===n.getMonth()&&vy===n.getFullYear();

  const ds=d=>`${vy}-${String(vm+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

  let cells='';
  for(let i=0;i<blanks;i++) cells+=`<div class="cal-blank"></div>`;
  for(let d=1;d<=dim;d++){
    const s=ds(d);
    const wk=isWeekend(s);
    const ukH=(PUBLIC_HOLIDAYS.UK[vy]||[]).find(h=>h.d===s);
    const inH=(PUBLIC_HOLIDAYS.India[vy]||[]).find(h=>h.d===s);
    const ll=state.leaves.filter(l=>l.status==='Approved'&&l.start<=s&&l.end>=s);
    const todayCls=isToday(d)?'cal-today':'';
    cells+=`<div class="cal-day${wk?' weekend':''} ${todayCls}">
      <div class="cal-num" style="color:${wk?'#CBD5E1':'var(--text)'}">${d}</div>
      ${ukH?`<div class="cal-tag" style="background:var(--uk-bg);color:var(--uk-text)">üá¨üáß ${ukH.n}</div>`:''}
      ${inH?`<div class="cal-tag" style="background:var(--in-bg);color:var(--in-text)">üáÆüá≥ ${inH.n}</div>`:''}
      ${ll.slice(0,2).map(l=>{
        const emp=state.employees.find(e=>e.id===l.empId);
        const co=emp?.country==='UK';
        return `<div class="cal-tag" style="background:${co?'var(--uk-bg)':'var(--in-bg)'};color:${co?'var(--uk-text)':'var(--in-text)'}">${co?'üá¨üáß':'üáÆüá≥'} ${emp?.name?.split(' ')[0]||''}</div>`;
      }).join('')}
      ${ll.length>2?`<div style="font-size:7.5px;color:var(--muted)">+${ll.length-2}</div>`:''}
    </div>`;
  }

  return `
  <div class="page-header">
    <div><div class="page-title">Team Calendar</div></div>
    <div style="display:flex;gap:9px;align-items:center">
      <button class="btn-ghost btn-sm" onclick="calNav(-1)">‚Äπ</button>
      <span style="font-weight:600;font-size:15px;min-width:155px;text-align:center">${MONTHS[vm]} ${vy}</span>
      <button class="btn-ghost btn-sm" onclick="calNav(1)">‚Ä∫</button>
    </div>
  </div>
  <div class="card" style="overflow:hidden">
    <div class="cal-grid">${DAYS.map(d=>`<div class="cal-hdr">${d}</div>`).join('')}${cells}</div>
  </div>
  <div style="display:flex;gap:14px;margin-top:12px;flex-wrap:wrap">
    ${[{bg:'var(--uk-bg)',c:'var(--uk-text)',l:'üá¨üáß UK on leave'},{bg:'var(--in-bg)',c:'var(--in-text)',l:'üáÆüá≥ India on leave'},
       {bg:'var(--uk-bg)',c:'var(--uk-text)',l:'üá¨üáß UK public holiday'},{bg:'var(--in-bg)',c:'var(--in-text)',l:'üáÆüá≥ India public holiday'}]
    .map(x=>`<div style="display:flex;align-items:center;gap:5px;font-size:10.5px;color:var(--muted)">
      <div style="width:10px;height:10px;background:${x.bg};border:1px solid ${x.c}44;border-radius:2px"></div>${x.l}</div>`).join('')}
  </div>`;
}

function calNav(dir){
  state.calMonth+=dir;
  if(state.calMonth<0){state.calMonth=11;state.calYear--;}
  if(state.calMonth>11){state.calMonth=0;state.calYear++;}
  renderInPlace();
}

// ‚îÄ‚îÄ‚îÄ HOLIDAYS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHolidays(){
  if(!state.holYear) state.holYear=state.year;
  const yr=state.holYear;

  const col=(co,cs)=>{
    const hols=PUBLIC_HOLIDAYS[co][yr]||[];
    return `<div class="card" style="overflow:hidden">
      <div style="padding:12px 16px;border-bottom:1px solid var(--border);background:${cs.bg};display:flex;align-items:center;gap:9px">
        <span style="font-size:20px">${cs.flag}</span>
        <div>
          <div style="font-weight:700;color:${cs.text};font-size:14px">${co==='UK'?'United Kingdom':'India'}</div>
          <div style="font-size:10.5px;color:${cs.text}99">${hols.length} statutory holidays</div>
        </div>
      </div>
      ${hols.length===0?'<div style="padding:30px;text-align:center;color:var(--muted)">No data for this year</div>':
        hols.map((h,i)=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 16px;${i<hols.length-1?'border-bottom:1px solid var(--border)':''}">
          <div>
            <div style="font-size:13px;font-weight:500;color:var(--navy)">${h.n}</div>
            <div style="font-size:10.5px;color:var(--muted)">${fmtWday(h.d)}</div>
          </div>
          <div style="font-size:12px;font-weight:600;color:var(--muted)">${fmt(h.d)}</div>
        </div>`).join('')}
    </div>`;
  };

  return `
  <div class="page-header">
    <div><div class="page-title">Public Holidays</div><div class="page-sub">Statutory holidays ¬∑ ${yr}</div></div>
    <div class="seg">
      ${[2024,2025,2026].map(y=>`<button class="seg-btn${state.holYear===y?' active':''}" onclick="state.holYear=${y};renderInPlace()">${y}</button>`).join('')}
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
    ${col('UK',{bg:'var(--uk-bg)',text:'var(--uk-text)',flag:'üá¨üáß'})}
    ${col('India',{bg:'var(--in-bg)',text:'var(--in-text)',flag:'üáÆüá≥'})}
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReports(){
  const rows=state.employees.map(emp=>{
    const base=proRata(emp.allowance,emp.joinDate,state.year);
    const cf=getCarryFwd(emp,state.year);
    const tot=base+cf;
    const used=getUsedDays(emp.id,state.year);
    const pend=state.leaves.filter(l=>l.empId===emp.id&&l.status==='Pending').reduce((s,l)=>s+(l.days||0),0);
    const rem=Math.max(0,tot-used-pend);
    const sick=state.leaves.filter(l=>l.empId===emp.id&&l.type==='Sick Leave'&&l.status==='Approved'&&new Date(l.start).getFullYear()===state.year).reduce((s,l)=>s+(l.days||0),0);
    return{...emp,base,cf,tot,used,pend,rem,sick};
  });

  const totals={
    allow:rows.reduce((s,r)=>s+r.tot,0),
    used:rows.reduce((s,r)=>s+r.used,0),
    cf:rows.reduce((s,r)=>s+r.cf,0),
    avgPct:rows.length?Math.round(rows.reduce((s,r)=>s+(r.tot>0?r.used/r.tot:0),0)/rows.length*100):0,
  };

  let viewHtml='';
  if(state.reportView==='summary'){
    viewHtml=`<div class="card" style="overflow:hidden">
      <table class="tbl"><thead><tr>
        <th>Employee</th><th>Country</th><th>Base</th><th>Carry Fwd</th><th>Total</th><th>Used</th><th>Pending</th><th>Remaining</th><th>Sick</th><th>Usage</th>
      </tr></thead><tbody>
      ${rows.map(r=>{
        const pct=r.tot>0?Math.round(r.used/r.tot*100):0;
        const barColor=pct>85?'#EF4444':r.country==='UK'?'var(--uk-acc)':'var(--in-acc)';
        return `<tr>
          <td><div style="font-size:13px;font-weight:600;color:var(--navy)">${r.name}</div><div style="font-size:10px;color:var(--muted)">${r.role}</div></td>
          <td>${countryBadge(r.country)}</td>
          <td style="font-size:12px">${r.base}d</td>
          <td style="font-size:12px;color:${r.cf>0?'#15803D':'var(--muted)'}">${r.cf>0?'+'+r.cf+'d':'‚Äî'}</td>
          <td style="font-size:12px;font-weight:700">${r.tot}d</td>
          <td style="font-size:12px">${r.used}d</td>
          <td style="font-size:12px;color:${r.pend>0?'#D97706':'var(--muted)'}">${r.pend>0?r.pend+'d':'‚Äî'}</td>
          <td style="font-size:12px;font-weight:600;color:${r.rem<3?'#EF4444':r.rem<6?'#D97706':'#15803D'}">${r.rem}d</td>
          <td style="font-size:12px;color:${r.sick>5?'#EF4444':'var(--muted)'}">${r.sick>0?r.sick+'d':'‚Äî'}</td>
          <td style="min-width:100px">
            <div style="display:flex;align-items:center;gap:5px">
              <div class="progress-track" style="flex:1;height:5px"><div class="progress-fill" style="width:${pct}%;background:${barColor}"></div></div>
              <span style="font-size:10px;font-weight:600;color:var(--muted);min-width:28px">${pct}%</span>
            </div>
          </td>
        </tr>`;
      }).join('')}
      </tbody></table>
    </div>`;
  } else if(state.reportView==='country'){
    viewHtml=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    ${['UK','India'].map(co=>{
      const cs=co==='UK'?{flag:'üá¨üáß',bg:'var(--uk-bg)',text:'var(--uk-text)',acc:'var(--uk-acc)'}:{flag:'üáÆüá≥',bg:'var(--in-bg)',text:'var(--in-text)',acc:'var(--in-acc)'};
      const gr=rows.filter(r=>r.country===co);
      return `<div class="card" style="overflow:hidden">
        <div style="padding:12px 16px;background:${cs.bg};border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
          <span style="font-size:20px">${cs.flag}</span>
          <div style="font-weight:700;color:${cs.text};font-size:14px">${co==='UK'?'United Kingdom':'India'} ‚Äî ${gr.length} employees</div>
        </div>
        <div style="padding:14px 16px">
          ${[['Employees',gr.length],['Total allowance',gr.reduce((s,r)=>s+r.tot,0)+'d'],['Total used',gr.reduce((s,r)=>s+r.used,0)+'d'],
            ['Total pending',gr.reduce((s,r)=>s+r.pend,0)+'d'],['Total remaining',gr.reduce((s,r)=>s+r.rem,0)+'d'],
            ['Total carry forward',gr.reduce((s,r)=>s+r.cf,0)+'d'],['Sick days',gr.reduce((s,r)=>s+r.sick,0)+'d']]
          .map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border)">
            <span style="font-size:12.5px;color:var(--muted)">${l}</span>
            <span style="font-size:13px;font-weight:700;color:var(--navy)">${v}</span>
          </div>`).join('')}
        </div>
        <div style="padding:0 16px 14px">
          <div style="font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px">By employee</div>
          ${gr.map(r=>{
            const pct=r.tot>0?Math.round(r.used/r.tot*100):0;
            return `<div style="margin-bottom:9px">
              <div style="display:flex;justify-content:space-between;font-size:11.5px;margin-bottom:3px">
                <span style="font-weight:500">${r.name}</span>
                <span style="color:var(--muted)">${r.used}d / ${r.tot}d (${pct}%)</span>
              </div>
              <div class="progress-track" style="height:5px">
                <div class="progress-fill" style="width:${pct}%;background:${pct>85?'#EF4444':cs.acc}"></div>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
    }).join('')}
    </div>`;
  } else {
    const yrL=state.leaves.filter(l=>new Date(l.start).getFullYear()===state.year&&l.status!=='Rejected');
    const byType=LEAVE_TYPES.map(type=>{
      const m=yrL.filter(l=>l.type===type);
      return{type,count:m.length,days:m.reduce((s,l)=>s+(l.days||0),0)};
    }).filter(x=>x.count>0).sort((a,b)=>b.days-a.days);
    const maxD=Math.max(...byType.map(x=>x.days),1);
    viewHtml=`<div class="card" style="padding:22px">
      <div style="font-size:14px;font-weight:700;color:var(--navy);margin-bottom:18px">Leave Type Breakdown ¬∑ ${state.year}</div>
      ${byType.length===0?'<div style="text-align:center;padding:30px;color:var(--muted)">No leave data for this year</div>':
        byType.map((x,i)=>`<div style="margin-bottom:16px">
          <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px">
            <span style="font-weight:500;color:var(--navy)">${x.type}</span>
            <span style="color:var(--muted)">${x.days} days ¬∑ ${x.count} request${x.count!==1?'s':''}</span>
          </div>
          <div class="rep-bar-track">
            <div class="rep-bar-fill" style="width:${x.days/maxD*100}%;background:hsl(${210-i*30},65%,50%)"></div>
          </div>
        </div>`).join('')}
    </div>`;
  }

  return `
  <div class="page-header">
    <div><div class="page-title">Reports & Analytics</div><div class="page-sub">Full leave analysis ¬∑ ${state.year}</div></div>
    <div style="display:flex;gap:8px">
      <button class="btn-ghost btn-sm" onclick="exportSummary()">‚¨á Summary CSV</button>
      <button class="btn-ghost btn-sm" onclick="exportDetail()">‚¨á Detail CSV</button>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:20px">
    ${[['Total Allowance',totals.allow+'d'],['Total Used',totals.used+'d'],['Total Carry Fwd',totals.cf+'d'],['Avg Utilisation',totals.avgPct+'%']].map(([l,v])=>`
      <div class="card" style="padding:14px 16px">
        <div style="font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--navy)">${v}</div>
        <div style="font-size:11.5px;color:var(--muted);margin-top:4px">${l}</div>
      </div>`).join('')}
  </div>
  <div style="margin-bottom:14px">
    <div class="seg">
      ${[['summary','Employee Summary'],['country','By Country'],['types','Leave Types']].map(([k,l])=>`
        <button class="seg-btn${state.reportView===k?' active':''}" onclick="state.reportView='${k}';renderInPlace()">${l}</button>`).join('')}
    </div>
  </div>
  ${viewHtml}`;
}

// ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddEmployee(){
  openModal(`
  <div class="modal-header">
    <div class="modal-title">Add Employee</div>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>
  <div class="modal-body">
    <div class="field"><label class="field-label">Full Name</label><input class="inp" id="m-name" placeholder="e.g. Sarah Johnson"></div>
    <div class="field"><label class="field-label">Role / Job Title</label><input class="inp" id="m-role" placeholder="e.g. Senior Developer"></div>
    <div class="grid-2">
      <div class="field"><label class="field-label">Country</label>
        <select class="inp" id="m-country" onchange="document.getElementById('m-allow').value=this.value==='UK'?25:21">
          <option value="UK">üá¨üáß United Kingdom</option>
          <option value="India">üáÆüá≥ India</option>
        </select>
      </div>
      <div class="field"><label class="field-label">Annual Leave (days)</label><input class="inp" id="m-allow" type="number" min="0" max="60" value="25"></div>
    </div>
    <div class="field"><label class="field-label">Join Date</label><input class="inp" id="m-join" type="date" value="${today()}"></div>
    <div class="cf-box">
      <div class="cf-title">Carry Forward Settings</div>
      <label class="check-row"><input type="checkbox" id="m-cf" checked> Enable carry forward of unused leave</label>
      <div class="field" id="cf-max-row"><label class="field-label">Max carry forward (days)</label><input class="inp" id="m-cfmax" type="number" min="0" max="20" value="5"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" style="flex:1" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" style="flex:2" onclick="saveEmployee()">Add Employee</button>
    </div>
  </div>`);
  document.getElementById('m-cf').onchange=e=>{
    document.getElementById('cf-max-row').style.display=e.target.checked?'block':'none';
  };
}

function saveEmployee(){
  const name=document.getElementById('m-name').value.trim();
  const role=document.getElementById('m-role').value.trim();
  if(!name||!role){alert('Please fill in all required fields.');return;}
  const emp={
    id:'e'+uid(),name,role,
    country:document.getElementById('m-country').value,
    allowance:parseInt(document.getElementById('m-allow').value)||25,
    joinDate:document.getElementById('m-join').value,
    cfEnabled:document.getElementById('m-cf').checked,
    cfMax:parseInt(document.getElementById('m-cfmax')?.value)||5,
  };
  state.employees.push(emp);
  persist(); closeModal(); render(); toast('Employee added');
}

function removeEmployee(id){
  const emp=state.employees.find(e=>e.id===id);
  if(!confirm(`Remove ${emp?.name||'this employee'}? All their leave records will also be removed.`)) return;
  state.employees=state.employees.filter(e=>e.id!==id);
  state.leaves=state.leaves.filter(l=>l.empId!==id);
  persist(); render(); toast('Employee removed');
}

function openApplyLeave(prefill={}){
  const empOpts=state.employees.map(e=>`<option value="${e.id}" ${prefill.empId===e.id?'selected':''}>${e.country==='UK'?'üá¨üáß':'üáÆüá≥'} ${e.name}</option>`).join('');
  const typeOpts=LEAVE_TYPES.map(t=>`<option value="${t}"${t==='Annual Leave'?' selected':''}>${t}</option>`).join('');
  openModal(`
  <div class="modal-header">
    <div class="modal-title">Apply for Leave</div>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>
  <div class="modal-body">
    <div class="field"><label class="field-label">Employee</label>
      <select class="inp" id="m-emp" onchange="updateBalanceChip()">${empOpts}</select>
    </div>
    <div id="balance-chip" class="bal-chip bal-ok" style="display:none"></div>
    <div class="field"><label class="field-label">Leave Type</label>
      <select class="inp" id="m-type" onchange="updateBalanceChip()">${typeOpts}</select>
    </div>
    <div class="grid-2">
      <div class="field"><label class="field-label">Start Date</label><input class="inp" id="m-start" type="date" value="${today()}" onchange="updateBalanceChip()"></div>
      <div class="field"><label class="field-label">End Date</label><input class="inp" id="m-end" type="date" value="${today()}" onchange="updateBalanceChip()"></div>
    </div>
    <div class="field"><label class="field-label">Reason (optional)</label><textarea class="inp" id="m-reason" rows="3" placeholder="Brief description‚Ä¶" style="resize:vertical"></textarea></div>
    <div class="modal-actions">
      <button class="btn-ghost" style="flex:1" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" style="flex:2" id="m-submit" onclick="saveLeave()">Submit Request</button>
    </div>
  </div>`,true);
  setTimeout(updateBalanceChip,50);
}

function updateBalanceChip(){
  const empId=document.getElementById('m-emp')?.value;
  const type=document.getElementById('m-type')?.value;
  const start=document.getElementById('m-start')?.value;
  const end=document.getElementById('m-end')?.value;
  const chip=document.getElementById('balance-chip');
  const btn=document.getElementById('m-submit');
  if(!empId||!start||!end||end<start){chip.style.display='none';return;}
  const emp=state.employees.find(e=>e.id===empId);
  if(!emp){chip.style.display='none';return;}
  const wd=calcWorkingDays(start,end,emp.country);
  const used=getUsedDays(empId,state.year);
  const tot=getTotalAllowance(emp,state.year);
  const cf=getCarryFwd(emp,state.year);
  const base=proRata(emp.allowance,emp.joinDate,state.year);
  const rem=Math.max(0,tot-used);
  const over=type==='Annual Leave'&&wd>rem;
  chip.style.display='flex';
  chip.className=`bal-chip ${over?'bal-warn':'bal-ok'}`;
  chip.innerHTML=`<span>${over?'‚ö†Ô∏è':'‚úÖ'}</span><span>${wd} working day${wd!==1?'s':''} ¬∑ ${over?`Exceeds balance of ${rem}d remaining`:`${rem}d remaining`} (Base: ${base}d${cf>0?' + '+cf+'d CF':''})</span>`;
  if(btn) btn.disabled=over,btn.style.opacity=over?.5:1,btn.style.cursor=over?'not-allowed':'pointer';
}

function saveLeave(){
  const empId=document.getElementById('m-emp').value;
  const start=document.getElementById('m-start').value;
  const end=document.getElementById('m-end').value;
  const type=document.getElementById('m-type').value;
  const reason=document.getElementById('m-reason').value;
  if(!empId||!start||!end){alert('Please fill all required fields.');return;}
  if(end<start){alert('End date must be on or after start date.');return;}
  const emp=state.employees.find(e=>e.id===empId);
  const wd=calcWorkingDays(start,end,emp.country);
  const used=getUsedDays(empId,state.year);
  const tot=getTotalAllowance(emp,state.year);
  if(type==='Annual Leave'&&wd>Math.max(0,tot-used)){alert('Insufficient annual leave balance.');return;}
  state.leaves.push({id:'l'+uid(),empId,type,start,end,days:wd,reason,status:'Pending',applied:today()});
  persist(); closeModal(); render(); toast('Leave request submitted');
}

function openLeaveDetail(id){
  const lv=state.leaves.find(l=>l.id===id);
  if(!lv) return;
  const emp=state.employees.find(e=>e.id===lv.empId);
  const cs=emp?.country==='UK'?{flag:'üá¨üáß',bg:'var(--uk-bg)',text:'var(--uk-text)'}:{flag:'üáÆüá≥',bg:'var(--in-bg)',text:'var(--in-text)'};

  const actionBtns=lv.status==='Pending'
    ?`<button class="btn-ghost btn-danger" style="flex:1" onclick="setLeaveStatus('${id}','Rejected')">‚úï Reject</button>
       <button class="btn-primary" style="flex:2;background:linear-gradient(135deg,#15803D,#16A34A)" onclick="setLeaveStatus('${id}','Approved')">‚úì Approve</button>`
    :lv.status==='Approved'
    ?`<button class="btn-ghost btn-danger" style="width:100%" onclick="setLeaveStatus('${id}','Rejected')">Revoke Approval</button>`:
    `<button class="btn-ghost" style="width:100%" onclick="setLeaveStatus('${id}','Pending')">Restore to Pending</button>`;

  openModal(`
  <div class="modal-header">
    <div class="modal-title">Leave Request</div>
    <button class="modal-close" onclick="closeModal()">‚úï</button>
  </div>
  <div class="modal-body">
    <div style="display:flex;align-items:center;gap:11px;margin-bottom:18px;padding:13px;background:var(--subtle);border-radius:9px">
      ${avHtml(emp?.name,emp?.country,42)}
      <div style="flex:1">
        <div style="font-weight:700;font-size:14px;color:var(--navy)">${emp?.name||'Unknown'}</div>
        <div style="font-size:11px;color:var(--muted)">${cs.flag} ${emp?.role||''}</div>
      </div>
      ${statusBadge(lv.status)}
    </div>
    ${[['Leave Type',lv.type],['Start Date',fmt(lv.start)],['End Date',fmt(lv.end)],
       ['Working Days',lv.days+' day'+(lv.days!==1?'s':'')],['Applied On',fmt(lv.applied)],['Reason',lv.reason||'‚Äî']]
    .map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:12.5px;color:var(--muted)">${l}</span>
      <span style="font-size:13px;font-weight:500;max-width:58%;text-align:right">${v}</span>
    </div>`).join('')}
    <div class="modal-actions">${actionBtns}</div>
  </div>`);
}

function setLeaveStatus(id,status){
  const lv=state.leaves.find(l=>l.id===id);
  if(lv) lv.status=status;
  persist(); closeModal(); render(); toast(`Leave ${status.toLowerCase()}`);
}

// ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportSummary(){
  const rows=state.employees.map(emp=>{
    const base=proRata(emp.allowance,emp.joinDate,state.year);
    const cf=getCarryFwd(emp,state.year);
    const tot=base+cf;
    const used=getUsedDays(emp.id,state.year);
    const pend=state.leaves.filter(l=>l.empId===emp.id&&l.status==='Pending').reduce((s,l)=>s+(l.days||0),0);
    const rem=Math.max(0,tot-used-pend);
    const sick=state.leaves.filter(l=>l.empId===emp.id&&l.type==='Sick Leave'&&l.status==='Approved'&&new Date(l.start).getFullYear()===state.year).reduce((s,l)=>s+(l.days||0),0);
    return{'Name':emp.name,'Role':emp.role,'Country':emp.country,'Join Date':emp.joinDate,'Base Allowance':base,'Carry Forward':cf,'Total Allowance':tot,'Used':used,'Pending':pend,'Remaining':rem,'Sick Days':sick};
  });
  dlCSV(rows,`leave-summary-${state.year}.csv`);
}

function exportDetail(){
  const rows=state.leaves.filter(l=>new Date(l.start).getFullYear()===state.year).map(l=>{
    const emp=state.employees.find(e=>e.id===l.empId)||{};
    return{'Employee':emp.name||'','Country':emp.country||'','Role':emp.role||'','Type':l.type,'Start':l.start,'End':l.end,'Working Days':l.days,'Status':l.status,'Reason':l.reason||'','Applied On':l.applied||''};
  });
  dlCSV(rows,`leave-detail-${state.year}.csv`);
}

function dlCSV(rows,filename){
  if(!rows.length){alert('No data to export.');return;}
  const h=Object.keys(rows[0]).join(',');
  const b=rows.map(r=>Object.values(r).map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([h+'\n'+b],{type:'text/csv'}));
  a.download=filename; a.click();
  toast(`Exported ${filename}`);
}

// ‚îÄ‚îÄ‚îÄ Partial re-render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderInPlace(){
  const el=document.getElementById('content');
  el.innerHTML='';
  const wrap=document.createElement('div');
  wrap.className='tab-content';
  wrap.innerHTML=renderTab();
  el.appendChild(wrap);
  attachTabEvents();
  updatePills();
}

function attachTabEvents(){
  // topbar year buttons re-attached on render
  document.querySelectorAll('.year-btn').forEach(b=>{
    b.onclick=()=>{state.year=parseInt(b.dataset.year);render();};
  });
  document.getElementById('btn-apply').onclick=()=>openApplyLeave();
  document.getElementById('btn-add-emp').onclick=()=>openAddEmployee();
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
hydrate();
render();
</script>
</body>
</html>
